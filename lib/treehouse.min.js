var h=class{loadAll(){let e=localStorage.getItem("treehouse-nodes");return e==="undefined"&&(e=void 0),JSON.parse(e||"[]")}saveAll(e){localStorage.setItem("treehouse-nodes",JSON.stringify(e))}save(e){}};var w=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let t of this.bindings)if(t.command===e)return t;return null}evaluateEvent(e){e:for(let t of this.bindings){let o=t.key.toLowerCase().split("+");if(o.pop()===e.key.toLowerCase()){for(let s of["shift","ctrl","meta","alt"]){let d=e[`${s}Key`];if(!d&&o.includes(s)||d&&!o.includes(s))continue e}return t}}return null}};var v=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...t){return this.commands[e].action(...t)}};var c=class{constructor(e,t){this.module=e,this.ID=t}changed(){this.module.changed(this)}get isDestroyed(){return!this.module.nodes.hasOwnProperty(this.ID)}get raw(){return this.module.nodes[this.ID]}getName(){return this.raw.Name}setName(e){this.raw.Name=e,this.changed()}getValue(){return this.raw.Value}getParent(){return this.raw.Parent?new c(this.module,this.raw.Parent):null}setParent(e){let t=this.getParent();t!==null&&t.raw.Linked.Children.splice(this.getSiblingIndex(),1),this.raw.Parent=e.ID,e.raw.Linked.Children.push(this.ID),this.changed()}getChildren(){return this.raw.Linked.Children?this.raw.Linked.Children.map(e=>new c(this.module,e)):[]}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,t){this.raw.Attrs[e]=t,this.changed()}getSiblingIndex(){let e=this.getParent();return e===null?0:e.raw.Linked.Children.findIndex(t=>t===this.ID)}setSiblingIndex(e){let t=this.getParent();t!==null&&(t.raw.Linked.Children.splice(this.getSiblingIndex(),1),t.raw.Linked.Children.splice(e,0,this.ID),t.changed())}getPrevSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===0?null:e.getChildren()[this.getSiblingIndex()-1]}getNextSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===e.getChildren().length-1?null:e.getChildren()[this.getSiblingIndex()+1]}destroy(){this.module.destroy(this)}},x=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}import(e){for(let t of e)this.nodes[t.ID]=t}export(){let e=[];for(let t of Object.values(this.nodes))e.push(t);return e}new(e,t){let o=e.startsWith("@")?e:I();return this.nodes[o]={ID:o,Name:e,Value:t,Linked:{Children:[],Components:[]},Attrs:{}},new c(this,o)}destroy(e){let t=e.getParent();t!==null&&t.raw.Linked.Children.splice(e.getSiblingIndex(),1),delete this.nodes[e.ID]}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new c(this,e.ID))}changed(e){this.observers.forEach(t=>t(e))}find(e){for(let t of Object.values(this.nodes))if(t.Name===e)return new c(this,t.ID);return null}},I=()=>{let n=Date.now().toString(36),e=Math.random().toString(36).substring(2);return n+e};function z(n){return{ID:I(),Name:n,Linked:{Children:[]},Attrs:{}}}function W(n){let e=[];for(let t=0;t<n;t++)e.push(z(q(g(2,6))));return e}function S(n){let e={},t=W(n);t.forEach(o=>{e[o.ID]=o,g(0,4)>0&&(o.Parent=t[g(0,n-1)].ID)});for(let[o,i]of Object.entries(e))i.Parent===i.ID&&(i.Parent=void 0),i.Parent&&e[i.Parent].Linked.Children.push(i.ID);return e}var D=["Got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];function V(n=!1){let e=D[g(0,D.length-1)];return n?e.charAt(0).toUpperCase()+e.slice(1):e}function q(n=10){return[...Array(n)].map((e,t)=>V(t===0)).join(" ").trim()}function g(n,e){return Math.round(Math.random()*(e-n)+n)}var y=class{constructor(){this.menus={}}registerMenu(e,t){this.menus[e]=t}};var k=class{constructor(e){this.workspace=new L(this,e),this.commands=new v,this.keybindings=new w,this.menus=new y}},b=class{constructor(e){e.panel=this,this.id=Math.random().toString(36).substring(2),this.history=[e]}};function a(n,e){return n.panel=e,n}var L=class{constructor(e,t){this.env=e,this.backend=t,this.manifold=new x;let o=this.backend.loadAll(),i=this.manifold.find("@root");if(o.length===0)for(let s of Object.values(S(1e3)))s.Parent===void 0&&(s.Parent="@root",i?.raw.Linked.Children.push(s.ID)),o.push(s);this.manifold.import(o),this.manifold.observers.push(s=>{this.backend.saveAll(Object.values(this.manifold.nodes))}),this.context={node:null},this.panels=[[]],this.expanded={},this.openNewPanel(this.manifold.find("@root"))}open(e){this.panels[0][0]=new b(e)}openNewPanel(e){this.expanded[e.ID]={};let t=new b(e);this.panels[0].push(t)}closePanel(e){this.panels.forEach((t,o)=>{this.panels[o]=t.filter(i=>i!==e)})}focus(e,t=0){this.context.node=e,document.getElementById(`input-${e.panel.id}-${e.ID}`)?.focus(),document.getElementById(`input-${e.panel.id}-${e.ID}`)?.setSelectionRange(t,t)}getInput(e){return document.getElementById(`input-${e.panel.id}-${e.ID}`)}executeCommand(e,t,...o){return this.env.commands.executeCommand(e,this.newContext(t),...o)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,t,o,i){let s=this.env.menus.menus[e];!s||(this.menu={x:t,y:o,ctx:this.newContext(i),items:s.map(d=>Object.assign(this.env.commands.commands[d.command],this.env.keybindings.getBinding(d.command)))},m.redraw())}hideMenu(){this.menu=null,m.redraw()}showPalette(e,t,o){this.palette={x:e,y:t,ctx:o},m.redraw()}hidePalette(){this.palette=null,m.redraw()}getExpanded(e){let t=this.expanded[e.panel.history[0].ID][e.ID];return t===void 0&&(t=!1),t}setExpanded(e,t){this.expanded[e.panel.history[0].ID][e.ID]=t}};var R={view({attrs:n}){let e={margin:"0px",listStyleType:"none",padding:"0.25rem 0.5rem 0.25rem 0.5rem",display:"flex"},t={flexGrow:"1",textAlign:"right",color:"#888",marginLeft:"1rem"},o=i=>s=>{env.workspace.executeCommand(i.id,n.ctx),env.workspace.hideMenu(),s.stopPropagation()};return m("ul",{class:"menu",style:{margin:"0",position:"absolute",left:`${n.x}px`,top:`${n.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0.25rem 0 0.25rem 0",display:"inline-block",background:"white",filter:"drop-shadow(2px 2px 4px #5555)",fontSize:"14px",minWidth:"200px"}},n.items.map(i=>m("li",{onclick:o(i),style:e},m("div",null,i.title),m("div",{style:t},i.key))))}};var B={onupdate({state:n,dom:e}){let t=e.querySelector(".commands").children;n.selected!==void 0&&t.length>0&&t[n.selected].scrollIntoView({block:"nearest"})},oncreate({dom:n}){n.querySelector("input").focus()},view({attrs:n,state:e}){e.filter=e.filter===void 0?"":e.filter;let o=Object.values(env.commands.commands).filter(d=>d.id.startsWith(e.filter)),i=d=>{let l=(p,u)=>(p%u+u)%u;if(d.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=l(e.selected+1,o.length),!1}if(d.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=l(e.selected-1,o.length),!1;if(d.key==="Enter")return e.selected!==void 0&&(env.commands.executeCommand(o[e.selected].id,n.ctx),env.workspace.hidePalette()),!1;d.key==="Escape"&&env.workspace.hidePalette()},s=d=>{e.filter=d.target.value,e.selected=0};return m("div",{class:"palette",style:{margin:"0",position:"absolute",left:`${n.x}px`,top:`${n.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0 0 0.25rem 0",background:"white",fontSize:"14px",minWidth:"200px"}},m("div",null,m("input",{style:{width:"100%"},type:"text",onkeydown:i,oninput:s,placeholder:"Enter command..."})),m("div",{class:"commands",style:{overflowY:"scroll",maxHeight:"100px",position:"relative"}},o.map((d,l)=>m("div",{class:e.selected===l?"selected":""},d.id))))}};var C={view({attrs:n,state:e,children:t}){let{node:o}=n,i=env.workspace.getExpanded(o),s=r=>{e.hover=!0,r.stopPropagation()},d=r=>{e.hover=!1,r.stopPropagation()},l=r=>{i?env.workspace.executeCommand("collapse",{node:o}):env.workspace.executeCommand("expand",{node:o}),r.stopPropagation()},p=r=>{env.workspace.context.node=o,e.editing=!0,e.buffer=o.getName()},u=r=>{e.editing=!1,o.isDestroyed||o.setName(e.buffer),e.buffer=void 0,env.workspace.context.node=null},E=r=>{e.buffer=r.target.value},O=r=>{env.workspace.executeCommand("insert-child",{node:o},r.target.value),r.stopPropagation()},T=r=>{let P=r.target.closest("*[data-menu]"),f=P.getBoundingClientRect(),$=document.body.scrollLeft+f.x,G=document.body.scrollTop+f.y+f.height;env.workspace.showMenu(P.dataset.menu,$,G,{node:o}),r.preventDefault()},j=r=>{switch(r.key){case"Backspace":if(r.target.value===""){env.workspace.executeCommand("delete",{node:o}),r.stopPropagation();return}if(r.target.value!==""&&r.target.selectionStart===0){console.log("TODO!"),r.stopPropagation();return}break;case"Enter":if(r.target.selectionStart===r.target.value.length){env.workspace.executeCommand("insert",{node:o}),r.stopPropagation();return}if(r.target.selectionStart===0){env.workspace.executeCommand("insert-before",{node:o}),r.stopPropagation();return}if(r.target.selectionStart>0&&r.target.selectionStart<r.target.value.length){e.buffer=r.target.value.slice(0,r.target.selectionStart),env.workspace.executeCommand("insert",{node:o},r.target.value.slice(r.target.selectionStart)),r.stopPropagation();return}break}};return m("div",{class:"",style:{paddingLeft:"1rem"},onmouseover:s,onmouseout:d},m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{flexShrink:"0",width:"1rem",height:"1rem",position:"absolute",marginLeft:"-1rem",userSelect:"none",display:e.hover?"block":"none"},onclick:l,fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),!i&&m("path",{style:{transform:"scale(0.6) translate(5px, 3px)"},d:"m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"}),i&&m("path",{style:{transform:"scale(0.6) translate(5px, 4px)"},d:"M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"})),m("svg",{oncontextmenu:T,"data-menu":"node",style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},o.getChildren().length>0?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{id:`input-${o.panel.id}-${o.ID}`,type:"text",value:e.editing?e.buffer:o.getName(),onfocus:p,onblur:u,oninput:E,onkeydown:j,style:{border:"0px",flexGrow:"1",outline:"0px"}}))),m("div",{style:{display:i?"flex":"none",flexDirection:"row",paddingBottom:"0.25rem"}},m("div",{style:{width:"1rem",marginRight:"0.25rem",display:"flex"},onclick:l},m("div",{style:{borderLeft:"1px solid gray",height:"100%",marginLeft:"0.5rem"}})),m("div",{style:{flexGrow:"1"}},o.getChildren().length>0?o.getChildren().map(r=>m(C,{key:r.ID,node:a(r,o.panel)})):m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:O,style:{border:"0px",flexGrow:"1",outline:"0px"}}))))))}};var M={view({attrs:n}){let e=n.panel,t=e.history[e.history.length-1],o=s=>{env.workspace.executeCommand("close-panel",{},e)},i=s=>{e.history.pop()};return m("div",{style:{flexGrow:"1",margin:"0.5rem"}},m("div",{style:{display:"flex"}},e.history.length>1?m("button",{onclick:i},"<"):null,m("div",{style:{flexGrow:"1"}},t.getName()),env.workspace.panels[0].length>1?m("button",{onclick:o},"x"):null),m("div",null,t.getChildren().map(s=>m(C,{key:s.ID,node:a(s,t.panel)}))))}};var A=(()=>navigator.userAgent.toLowerCase().indexOf("win")!=-1?"win":navigator.userAgent.toLowerCase().indexOf("mac")!=-1?"mac":navigator.userAgent.toLowerCase().indexOf("linux")!=-1?"linux":navigator.userAgent.toLowerCase().indexOf("x11")!=-1?"unix":"unknown")(),N=function(n){let e=Object.keys(n);if(e.length<=0)throw new Error("Invalid options record object given, must contain at least one option");return e.includes(A)?n[A]:e.includes("*")?n["*"]:n[e[0]]};window.env=new k(new h);env.commands.registerCommand({id:"expand",title:"Expand",action:n=>{!n.node||(env.workspace.setExpanded(n.node,!0),m.redraw())}});env.keybindings.registerBinding({command:"expand",key:N({mac:"meta+arrowdown","*":"ctrl+arrowdown"})});env.commands.registerCommand({id:"collapse",title:"Collapse",action:n=>{!n.node||(env.workspace.setExpanded(n.node,!1),m.redraw())}});env.keybindings.registerBinding({command:"collapse",key:N({mac:"meta+arrowup","*":"ctrl+arrowup"})});env.commands.registerCommand({id:"indent",title:"Indent",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();e!==null&&(n.node.setParent(e),e.setAttr("expanded",JSON.stringify(!0)),m.redraw.sync(),env.workspace.focus(n.node))}});env.keybindings.registerBinding({command:"indent",key:"tab"});env.commands.registerCommand({id:"outdent",title:"Outdent",action:n=>{if(!n.node)return;let e=n.node.getParent();e!==null&&e.ID!=="@root"&&(n.node.setParent(e.getParent()),n.node.setSiblingIndex(e.getSiblingIndex()+1),m.redraw.sync(),env.workspace.focus(n.node))}});env.keybindings.registerBinding({command:"outdent",key:"shift+tab"});env.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(n,e="")=>{if(!n.node)return;env.workspace.manifold.new(e).setParent(n.node),m.redraw.sync(),env.workspace.focus(n.node,e.length)}});env.commands.registerCommand({id:"insert-before",title:"Insert Before",action:n=>{if(!n.node)return;let e=env.workspace.manifold.new("");e.setParent(n.node.getParent()),e.setSiblingIndex(n.node.getSiblingIndex()),m.redraw.sync(),env.workspace.focus(a(e,n.node.panel))}});env.commands.registerCommand({id:"insert",title:"Insert Node",action:(n,e="")=>{if(!n.node)return;let t=env.workspace.manifold.new(e);t.setParent(n.node.getParent()),t.setSiblingIndex(n.node.getSiblingIndex()+1),m.redraw.sync(),env.workspace.focus(a(t,n.node.panel))}});env.keybindings.registerBinding({command:"insert",key:"shift+enter"});env.commands.registerCommand({id:"delete",title:"Delete node",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();n.node.destroy(),m.redraw.sync(),e&&env.workspace.focus(a(e,n.node.panel))}});env.keybindings.registerBinding({command:"delete",key:N({mac:"shift+meta+backspace","*":"shift+ctrl+backspace"})});env.commands.registerCommand({id:"prev",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();e!==null?env.workspace.focus(a(e,n.node.panel)):env.workspace.focus(a(n.node.getParent(),n.node.panel))}});env.keybindings.registerBinding({command:"prev",key:"arrowup"});env.commands.registerCommand({id:"next",action:n=>{if(!n.node)return;let e=n.node.getNextSibling();e!==null?env.workspace.focus(a(e,n.node.panel)):env.workspace.focus(a(n.node.getParent().getNextSibling(),n.node.panel))}});env.keybindings.registerBinding({command:"next",key:"arrowdown"});env.commands.registerCommand({id:"pick-command",action:n=>{if(!n.node)return;let t=env.workspace.getInput(n.node).getBoundingClientRect(),o=document.body.scrollLeft+t.x+200,i=document.body.scrollTop+t.y;env.workspace.showPalette(o,i,env.workspace.newContext({node:n.node}))}});env.keybindings.registerBinding({command:"pick-command",key:"meta+k"});env.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:n=>{!n.node||(env.workspace.openNewPanel(n.node),m.redraw())}});env.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(n,e)=>{env.workspace.closePanel(e||n.node.panel),m.redraw()}});env.commands.registerCommand({id:"zoom",title:"Zoom",action:n=>{n.node.panel.history.push(n.node),m.redraw()}});env.menus.registerMenu("node",[{command:"zoom"},{command:"new-panel"},{command:"indent"},{command:"outdent"},{command:"delete"}]);document.addEventListener("keydown",n=>{let e=env.keybindings.evaluateEvent(n);e&&env.workspace.context.node&&(env.commands.executeCommand(e.command,env.workspace.context),n.stopPropagation(),n.preventDefault())});document.addEventListener("click",n=>{env.workspace.hideMenu()});var K={view(n){return m("main",null,m("button",{onclick:t=>{localStorage.clear(),location.reload()}},"Reset"),env.workspace.panels.map(t=>m("div",{style:{display:"flex"}},t.map(o=>m(M,{panel:o})))),env.workspace.menu&&m(R,{...env.workspace.menu}),env.workspace.palette&&m(B,{...env.workspace.palette}))}};export{K as App};
