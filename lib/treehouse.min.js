var c={view({attrs:t,state:e,children:n}){let i=t.data,o=i.getAttr("expanded")!==""?JSON.parse(i.getAttr("expanded")):!1,a=r=>{e.hover=!0,r.stopPropagation()},d=r=>{e.hover=!1,r.stopPropagation()},w=r=>{o?env.commands.executeCommand("collapse",i):env.commands.executeCommand("expand",i),r.stopPropagation()},k=r=>{env.workspace.currentNode=i,e.editing=!0,e.buffer=i.getName()},C=r=>{e.editing=!1,i.isDestroyed||i.setName(e.buffer),e.buffer=void 0,env.workspace.currentNode=void 0},S=r=>{e.buffer=r.target.value},I=r=>{env.commands.executeCommand("insert-child",i,r.target.value),r.stopPropagation()},P=r=>{switch(r.key){case"Backspace":if(r.target.value===""){env.commands.executeCommand("delete",i),r.stopPropagation();return}if(r.target.value!==""&&r.target.selectionStart===0){console.log("TODO!"),r.stopPropagation();return}break;case"Enter":if(r.target.selectionStart===r.target.value.length){env.commands.executeCommand("insert"),r.stopPropagation();return}if(r.target.selectionStart===0){env.commands.executeCommand("insert-before"),r.stopPropagation();return}if(r.target.selectionStart>0&&r.target.selectionStart<r.target.value.length){e.buffer=r.target.value.slice(0,r.target.selectionStart),env.commands.executeCommand("insert",r.target.value.slice(r.target.selectionStart)),r.stopPropagation();return}break}};return m("div",{class:"",style:{paddingLeft:"1rem"},onmouseover:a,onmouseout:d},m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{flexShrink:"0",width:"1rem",height:"1rem",position:"absolute",marginLeft:"-1rem",userSelect:"none",display:e.hover?"block":"none"},onclick:w,fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),!o&&m("path",{style:{transform:"scale(0.6) translate(5px, 3px)"},d:"m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"}),o&&m("path",{style:{transform:"scale(0.6) translate(5px, 4px)"},d:"M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"})),m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},i.getChildren().length>0?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{id:`input-${i.ID}`,type:"text",value:e.editing?e.buffer:i.getName(),onfocus:k,onblur:C,oninput:S,onkeydown:P,style:{border:"0px",flexGrow:"1",outline:"0px"}}))),m("div",{style:{display:o?"flex":"none",flexDirection:"row",paddingBottom:"0.25rem"}},m("div",{style:{width:"1rem",marginRight:"0.25rem",display:"flex"},onclick:w},m("div",{style:{borderLeft:"1px solid gray",height:"100%",marginLeft:"0.5rem"}})),m("div",{style:{flexGrow:"1"}},i.getChildren().length>0?i.getChildren().map(r=>m(c,{key:r.ID,data:r})):m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:I,style:{border:"0px",flexGrow:"1",outline:"0px"}}))))))}};var g=class{loadAll(){let e=localStorage.getItem("treehouse-nodes");return e==="undefined"&&(e=void 0),JSON.parse(e||"[]")}saveAll(e){localStorage.setItem("treehouse-nodes",JSON.stringify(e))}save(e){}};var u=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}evaluateEvent(e){e:for(let n of this.bindings){let i=n.key.toLowerCase().split("+");if(i.pop()===e.key.toLowerCase()){for(let a of["shift","ctrl","meta","alt"]){let d=e[`${a}Key`];if(!d&&i.includes(a)||d&&!i.includes(a))continue e}return n}}return null}};var p=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...n){return this.commands[e].action(...n)}};var s=class{constructor(e,n){this.module=e,this.ID=n}changed(){this.module.changed(this)}get isDestroyed(){return!this.module.nodes.hasOwnProperty(this.ID)}get raw(){return this.module.nodes[this.ID]}getName(){return this.raw.Name}setName(e){this.raw.Name=e,this.changed()}getValue(){return this.raw.Value}getParent(){return this.raw.Parent?new s(this.module,this.raw.Parent):null}setParent(e){let n=this.getParent();n!==null&&n.raw.Linked.Children.splice(this.getSiblingIndex(),1),this.raw.Parent=e.ID,e.raw.Linked.Children.push(this.ID),this.changed()}getChildren(){return this.raw.Linked.Children?this.raw.Linked.Children.map(e=>new s(this.module,e)):[]}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,n){this.raw.Attrs[e]=n,this.changed()}getSiblingIndex(){let e=this.getParent();return e===null?0:e.raw.Linked.Children.findIndex(n=>n===this.ID)}setSiblingIndex(e){let n=this.getParent();n!==null&&(n.raw.Linked.Children.splice(this.getSiblingIndex(),1),n.raw.Linked.Children.splice(e,0,this.ID),n.changed())}getPrevSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===0?null:e.getChildren()[this.getSiblingIndex()-1]}getNextSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===e.getChildren().length-1?null:e.getChildren()[this.getSiblingIndex()+1]}destroy(){this.module.destroy(this)}},h=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}import(e){for(let n of e)this.nodes[n.ID]=n}export(){let e=[];for(let n of Object.values(this.nodes))e.push(n);return e}new(e,n){let i=e.startsWith("@")?e:x();return this.nodes[i]={ID:i,Name:e,Value:n,Linked:{Children:[],Components:[]},Attrs:{}},new s(this,i)}destroy(e){let n=e.getParent();n!==null&&n.raw.Linked.Children.splice(e.getSiblingIndex(),1),delete this.nodes[e.ID]}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new s(this,e.ID))}changed(e){this.observers.forEach(n=>n(e))}find(e){for(let n of Object.values(this.nodes))if(n.Name===e)return new s(this,n.ID);return null}},x=()=>{let t=Date.now().toString(36),e=Math.random().toString(36).substring(2);return t+e};function D(t){return{ID:x(),Name:t,Linked:{Children:[]},Attrs:{}}}function R(t){let e=[];for(let n=0;n<t;n++)e.push(D(L(l(2,6))));return e}function y(t){let e={},n=R(t);n.forEach(i=>{e[i.ID]=i,l(0,4)>0&&(i.Parent=n[l(0,t-1)].ID)});for(let[i,o]of Object.entries(e))o.Parent===o.ID&&(o.Parent=void 0),o.Parent&&e[o.Parent].Linked.Children.push(o.ID);return e}var N=["Got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];function A(t=!1){let e=N[l(0,N.length-1)];return t?e.charAt(0).toUpperCase()+e.slice(1):e}function L(t=10){return[...Array(t)].map((e,n)=>A(n===0)).join(" ").trim()}function l(t,e){return Math.round(Math.random()*(e-t)+t)}var f=class{constructor(){this.menus={}}registerMenu(e){this.menus[e.id]=e}};var v=class{constructor(e){this.workspace=new b(e),this.commands=new p,this.keybindings=new u,this.menus=new f}},b=class{constructor(e){this.backend=e,this.manifold=new h;let n=this.backend.loadAll(),i=this.manifold.find("@root");if(n.length===0)for(let o of Object.values(y(1e3)))o.Parent===void 0&&(o.Parent="@root",i?.raw.Linked.Children.push(o.ID)),n.push(o);this.manifold.import(n),this.manifold.observers.push(o=>{this.backend.saveAll(Object.values(this.manifold.nodes))})}setCurrentNode(e,n=0){this.currentNode=e,e&&(document.getElementById(`input-${e.ID}`)?.focus(),document.getElementById(`input-${e.ID}`)?.setSelectionRange(n,n))}};window.env=new v(new g);env.commands.registerCommand({id:"expand",action:t=>{t.setAttr("expanded",JSON.stringify(!0)),m.redraw()}});env.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"});env.commands.registerCommand({id:"collapse",action:t=>{t.setAttr("expanded",JSON.stringify(!1)),m.redraw()}});env.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"});env.commands.registerCommand({id:"indent",action:t=>{let e=t.getPrevSibling();e!==null&&(t.setParent(e),e.setAttr("expanded",JSON.stringify(!0)),m.redraw.sync(),env.workspace.setCurrentNode(t))}});env.keybindings.registerBinding({command:"indent",key:"tab"});env.commands.registerCommand({id:"outdent",action:t=>{let e=t.getParent();e!==null&&e.ID!=="@root"&&(t.setParent(e.getParent()),t.setSiblingIndex(e.getSiblingIndex()+1),m.redraw.sync(),env.workspace.setCurrentNode(t))}});env.keybindings.registerBinding({command:"outdent",key:"shift+tab"});env.commands.registerCommand({id:"insert-child",action:(t,e="")=>{let n=env.workspace.manifold.new(e);n.setParent(t),m.redraw.sync(),env.workspace.setCurrentNode(n,e.length)}});env.commands.registerCommand({id:"insert-before",action:()=>{let t=env.workspace.manifold.new("");t.setParent(env.workspace.currentNode.getParent()),t.setSiblingIndex(env.workspace.currentNode.getSiblingIndex()),m.redraw.sync(),env.workspace.setCurrentNode(t)}});env.commands.registerCommand({id:"insert",action:(t="")=>{let e=env.workspace.manifold.new(t);e.setParent(env.workspace.currentNode.getParent()),e.setSiblingIndex(env.workspace.currentNode.getSiblingIndex()+1),m.redraw.sync(),env.workspace.setCurrentNode(e)}});env.keybindings.registerBinding({command:"insert",key:"shift+enter"});env.commands.registerCommand({id:"delete",action:t=>{let e=t.getPrevSibling();t.destroy(),m.redraw.sync(),e&&env.workspace.setCurrentNode(e)}});env.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"});env.commands.registerCommand({id:"prev",action:t=>{let e=t.getPrevSibling();e!==null?env.workspace.setCurrentNode(e):env.workspace.setCurrentNode(t.getParent())}});env.keybindings.registerBinding({command:"prev",key:"arrowup"});env.commands.registerCommand({id:"next",action:t=>{let e=t.getNextSibling();e!==null?env.workspace.setCurrentNode(e):env.workspace.setCurrentNode(t.getParent().getNextSibling())}});env.keybindings.registerBinding({command:"next",key:"arrowdown"});document.addEventListener("keydown",t=>{let e=env.keybindings.evaluateEvent(t);e&&env.workspace.currentNode&&(env.commands.executeCommand(e.command,env.workspace.currentNode),t.stopPropagation(),t.preventDefault())});var B={view(t){return m("main",null,m("button",{onclick:n=>{localStorage.clear(),location.reload()}},"Reset"),env.workspace.manifold.find("@root").getChildren().map(n=>m(c,{key:n.ID,data:n})))}};export{B as App};
