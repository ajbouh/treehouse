var f={view({attrs:n,state:e,children:t}){let r=n.data,i=r.getAttr("expanded")!==""?JSON.parse(r.getAttr("expanded")):!1,s=o=>{e.hover=!0,o.stopPropagation()},d=o=>{e.hover=!1,o.stopPropagation()},a=o=>{i?env.commands.executeCommand("collapse",env.workspace.getContext({node:r})):env.commands.executeCommand("expand",env.workspace.getContext({node:r})),o.stopPropagation()},u=o=>{env.workspace.context.node=r,e.editing=!0,e.buffer=r.getName()},c=o=>{e.editing=!1,r.isDestroyed||r.setName(e.buffer),e.buffer=void 0,env.workspace.context.node=null},R=o=>{e.buffer=o.target.value},B=o=>{env.commands.executeCommand("insert-child",env.workspace.getContext({node:r}),o.target.value),o.stopPropagation()},A=o=>{let b=o.target.closest("*[data-menu]"),p=b.getBoundingClientRect(),M=document.body.scrollLeft+p.x,O=document.body.scrollTop+p.y+p.height;env.workspace.showMenu(b.dataset.menu,M,O,env.workspace.getContext({node:r})),o.preventDefault()},L=o=>{switch(o.key){case"Backspace":if(o.target.value===""){env.commands.executeCommand("delete",env.workspace.getContext({node:r})),o.stopPropagation();return}if(o.target.value!==""&&o.target.selectionStart===0){console.log("TODO!"),o.stopPropagation();return}break;case"Enter":if(o.target.selectionStart===o.target.value.length){env.commands.executeCommand("insert",env.workspace.getContext({node:r})),o.stopPropagation();return}if(o.target.selectionStart===0){env.commands.executeCommand("insert-before",env.workspace.getContext({node:r})),o.stopPropagation();return}if(o.target.selectionStart>0&&o.target.selectionStart<o.target.value.length){e.buffer=o.target.value.slice(0,o.target.selectionStart),env.commands.executeCommand("insert",env.workspace.getContext({node:r}),o.target.value.slice(o.target.selectionStart)),o.stopPropagation();return}break}};return m("div",{class:"",style:{paddingLeft:"1rem"},onmouseover:s,onmouseout:d},m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{flexShrink:"0",width:"1rem",height:"1rem",position:"absolute",marginLeft:"-1rem",userSelect:"none",display:e.hover?"block":"none"},onclick:a,fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),!i&&m("path",{style:{transform:"scale(0.6) translate(5px, 3px)"},d:"m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"}),i&&m("path",{style:{transform:"scale(0.6) translate(5px, 4px)"},d:"M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"})),m("svg",{oncontextmenu:A,"data-menu":"node",style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},r.getChildren().length>0?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{id:`input-${r.ID}`,type:"text",value:e.editing?e.buffer:r.getName(),onfocus:u,onblur:c,oninput:R,onkeydown:L,style:{border:"0px",flexGrow:"1",outline:"0px"}}))),m("div",{style:{display:i?"flex":"none",flexDirection:"row",paddingBottom:"0.25rem"}},m("div",{style:{width:"1rem",marginRight:"0.25rem",display:"flex"},onclick:a},m("div",{style:{borderLeft:"1px solid gray",height:"100%",marginLeft:"0.5rem"}})),m("div",{style:{flexGrow:"1"}},r.getChildren().length>0?r.getChildren().map(o=>m(f,{key:o.ID,data:o})):m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:B,style:{border:"0px",flexGrow:"1",outline:"0px"}}))))))}};var h=class{loadAll(){let e=localStorage.getItem("treehouse-nodes");return e==="undefined"&&(e=void 0),JSON.parse(e||"[]")}saveAll(e){localStorage.setItem("treehouse-nodes",JSON.stringify(e))}save(e){}};var v=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let t of this.bindings)if(t.command===e)return t;return null}evaluateEvent(e){e:for(let t of this.bindings){let r=t.key.toLowerCase().split("+");if(r.pop()===e.key.toLowerCase()){for(let s of["shift","ctrl","meta","alt"]){let d=e[`${s}Key`];if(!d&&r.includes(s)||d&&!r.includes(s))continue e}return t}}return null}};var w=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...t){return this.commands[e].action(...t)}};var l=class{constructor(e,t){this.module=e,this.ID=t}changed(){this.module.changed(this)}get isDestroyed(){return!this.module.nodes.hasOwnProperty(this.ID)}get raw(){return this.module.nodes[this.ID]}getName(){return this.raw.Name}setName(e){this.raw.Name=e,this.changed()}getValue(){return this.raw.Value}getParent(){return this.raw.Parent?new l(this.module,this.raw.Parent):null}setParent(e){let t=this.getParent();t!==null&&t.raw.Linked.Children.splice(this.getSiblingIndex(),1),this.raw.Parent=e.ID,e.raw.Linked.Children.push(this.ID),this.changed()}getChildren(){return this.raw.Linked.Children?this.raw.Linked.Children.map(e=>new l(this.module,e)):[]}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,t){this.raw.Attrs[e]=t,this.changed()}getSiblingIndex(){let e=this.getParent();return e===null?0:e.raw.Linked.Children.findIndex(t=>t===this.ID)}setSiblingIndex(e){let t=this.getParent();t!==null&&(t.raw.Linked.Children.splice(this.getSiblingIndex(),1),t.raw.Linked.Children.splice(e,0,this.ID),t.changed())}getPrevSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===0?null:e.getChildren()[this.getSiblingIndex()-1]}getNextSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===e.getChildren().length-1?null:e.getChildren()[this.getSiblingIndex()+1]}destroy(){this.module.destroy(this)}},x=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}import(e){for(let t of e)this.nodes[t.ID]=t}export(){let e=[];for(let t of Object.values(this.nodes))e.push(t);return e}new(e,t){let r=e.startsWith("@")?e:C();return this.nodes[r]={ID:r,Name:e,Value:t,Linked:{Children:[],Components:[]},Attrs:{}},new l(this,r)}destroy(e){let t=e.getParent();t!==null&&t.raw.Linked.Children.splice(e.getSiblingIndex(),1),delete this.nodes[e.ID]}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new l(this,e.ID))}changed(e){this.observers.forEach(t=>t(e))}find(e){for(let t of Object.values(this.nodes))if(t.Name===e)return new l(this,t.ID);return null}},C=()=>{let n=Date.now().toString(36),e=Math.random().toString(36).substring(2);return n+e};function E(n){return{ID:C(),Name:n,Linked:{Children:[]},Attrs:{}}}function j(n){let e=[];for(let t=0;t<n;t++)e.push(E($(g(2,6))));return e}function N(n){let e={},t=j(n);t.forEach(r=>{e[r.ID]=r,g(0,4)>0&&(r.Parent=t[g(0,n-1)].ID)});for(let[r,i]of Object.entries(e))i.Parent===i.ID&&(i.Parent=void 0),i.Parent&&e[i.Parent].Linked.Children.push(i.ID);return e}var S=["Got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];function T(n=!1){let e=S[g(0,S.length-1)];return n?e.charAt(0).toUpperCase()+e.slice(1):e}function $(n=10){return[...Array(n)].map((e,t)=>T(t===0)).join(" ").trim()}function g(n,e){return Math.round(Math.random()*(e-n)+n)}var y=class{constructor(){this.menus={}}registerMenu(e,t){this.menus[e]=t}};var k=class{constructor(e){this.workspace=new I(this,e),this.commands=new w,this.keybindings=new v,this.menus=new y}},I=class{constructor(e,t){this.env=e,this.backend=t,this.manifold=new x;let r=this.backend.loadAll(),i=this.manifold.find("@root");if(r.length===0)for(let s of Object.values(N(1e3)))s.Parent===void 0&&(s.Parent="@root",i?.raw.Linked.Children.push(s.ID)),r.push(s);this.manifold.import(r),this.manifold.observers.push(s=>{this.backend.saveAll(Object.values(this.manifold.nodes))}),this.context={node:null}}setCurrentNode(e,t=0){this.context.node=e,e&&(document.getElementById(`input-${e.ID}`)?.focus(),document.getElementById(`input-${e.ID}`)?.setSelectionRange(t,t))}getContext(e){return Object.assign({},this.context,e)}showMenu(e,t,r,i){let s=this.env.menus.menus[e];!s||(this.menu={x:t,y:r,ctx:i,items:s.map(d=>Object.assign(this.env.commands.commands[d.command],this.env.keybindings.getBinding(d.command)))},m.redraw())}hideMenu(){this.menu=null,m.redraw()}showPalette(e,t,r){this.palette={x:e,y:t,ctx:r},m.redraw()}hidePalette(){this.palette=null,m.redraw()}};var P={view({attrs:n}){let e={margin:"0px",listStyleType:"none",padding:"0.25rem 0.5rem 0.25rem 0.5rem",display:"flex"},t={flexGrow:"1",textAlign:"right",color:"#888",marginLeft:"1rem"},r=i=>s=>{env.commands.executeCommand(i.command,env.workspace.getContext(n.ctx)),env.workspace.hideMenu(),s.stopPropagation()};return m("ul",{class:"menu",style:{margin:"0",position:"absolute",left:`${n.x}px`,top:`${n.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0.25rem 0 0.25rem 0",display:"inline-block",background:"white",filter:"drop-shadow(2px 2px 4px #5555)",fontSize:"14px",minWidth:"200px"}},n.items.map(i=>m("li",{onclick:r(i),style:e},m("div",null,i.title),m("div",{style:t},i.key))))}};var D={onupdate({state:n,dom:e}){let t=e.querySelector(".commands").children;n.selected!==void 0&&t.length>0&&t[n.selected].scrollIntoView({block:"nearest"})},oncreate({dom:n}){n.querySelector("input").focus()},view({attrs:n,state:e}){e.filter=e.filter===void 0?"":e.filter;let r=Object.values(env.commands.commands).filter(d=>d.id.startsWith(e.filter)),i=d=>{let a=(u,c)=>(u%c+c)%c;if(d.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=a(e.selected+1,r.length),!1}if(d.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=a(e.selected-1,r.length),!1;if(d.key==="Enter")return e.selected!==void 0&&(env.commands.executeCommand(r[e.selected].id,n.ctx),env.workspace.hidePalette()),!1;d.key==="Escape"&&env.workspace.hidePalette()},s=d=>{e.filter=d.target.value,e.selected=0};return m("div",{class:"palette",style:{margin:"0",position:"absolute",left:`${n.x}px`,top:`${n.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0 0 0.25rem 0",background:"white",fontSize:"14px",minWidth:"200px"}},m("div",null,m("input",{style:{width:"100%"},type:"text",onkeydown:i,oninput:s,placeholder:"Enter command..."})),m("div",{class:"commands",style:{overflowY:"scroll",maxHeight:"100px",position:"relative"}},r.map((d,a)=>m("div",{class:e.selected===a?"selected":""},d.id))))}};window.env=new k(new h);env.commands.registerCommand({id:"expand",title:"Expand",action:n=>{!n.node||(n.node.setAttr("expanded",JSON.stringify(!0)),m.redraw())}});env.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"});env.commands.registerCommand({id:"collapse",title:"Collapse",action:n=>{!n.node||(n.node.setAttr("expanded",JSON.stringify(!1)),m.redraw())}});env.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"});env.commands.registerCommand({id:"indent",title:"Indent",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();e!==null&&(n.node.setParent(e),e.setAttr("expanded",JSON.stringify(!0)),m.redraw.sync(),env.workspace.setCurrentNode(n.node))}});env.keybindings.registerBinding({command:"indent",key:"tab"});env.commands.registerCommand({id:"outdent",title:"Outdent",action:n=>{if(!n.node)return;let e=n.node.getParent();e!==null&&e.ID!=="@root"&&(n.node.setParent(e.getParent()),n.node.setSiblingIndex(e.getSiblingIndex()+1),m.redraw.sync(),env.workspace.setCurrentNode(n.node))}});env.keybindings.registerBinding({command:"outdent",key:"shift+tab"});env.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(n,e="")=>{if(!n.node)return;let t=env.workspace.manifold.new(e);t.setParent(n.node),m.redraw.sync(),env.workspace.setCurrentNode(t,e.length)}});env.commands.registerCommand({id:"insert-before",title:"Insert Before",action:n=>{if(!n.node)return;let e=env.workspace.manifold.new("");e.setParent(n.node.getParent()),e.setSiblingIndex(n.node.getSiblingIndex()),m.redraw.sync(),env.workspace.setCurrentNode(e)}});env.commands.registerCommand({id:"insert",title:"Insert Node",action:(n,e="")=>{if(!n.node)return;let t=env.workspace.manifold.new(e);t.setParent(n.node.getParent()),t.setSiblingIndex(n.node.getSiblingIndex()+1),m.redraw.sync(),env.workspace.setCurrentNode(t)}});env.keybindings.registerBinding({command:"insert",key:"shift+enter"});env.commands.registerCommand({id:"delete",title:"Delete node",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();n.node.destroy(),m.redraw.sync(),e&&env.workspace.setCurrentNode(e)}});env.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"});env.commands.registerCommand({id:"prev",action:n=>{if(!n.node)return;let e=n.node.getPrevSibling();e!==null?env.workspace.setCurrentNode(e):env.workspace.setCurrentNode(n.node.getParent())}});env.keybindings.registerBinding({command:"prev",key:"arrowup"});env.commands.registerCommand({id:"next",action:n=>{if(!n.node)return;let e=n.node.getNextSibling();e!==null?env.workspace.setCurrentNode(e):env.workspace.setCurrentNode(n.node.getParent().getNextSibling())}});env.keybindings.registerBinding({command:"next",key:"arrowdown"});env.commands.registerCommand({id:"pick-command",action:n=>{if(!n.node)return;let t=document.getElementById(`input-${n.node.ID}`).getBoundingClientRect(),r=document.body.scrollLeft+t.x+200,i=document.body.scrollTop+t.y;env.workspace.showPalette(r,i,env.workspace.getContext({node:n.node}))}});env.keybindings.registerBinding({command:"pick-command",key:"meta+k"});env.menus.registerMenu("node",[{command:"indent"},{command:"outdent"},{command:"delete"}]);document.addEventListener("keydown",n=>{let e=env.keybindings.evaluateEvent(n);e&&env.workspace.context.node&&(env.commands.executeCommand(e.command,env.workspace.context),n.stopPropagation(),n.preventDefault())});document.addEventListener("click",n=>{env.workspace.hideMenu()});var G={view(n){return m("main",null,m("button",{onclick:t=>{localStorage.clear(),location.reload()}},"Reset"),env.workspace.manifold.find("@root").getChildren().map(t=>m(f,{key:t.ID,data:t})),env.workspace.menu&&m(P,{...env.workspace.menu}),env.workspace.palette&&m(D,{...env.workspace.palette}))}};export{G as App};
