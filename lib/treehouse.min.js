var X=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var a=(r,e)=>X(r,"name",{value:e,configurable:!0});var y=(r,e,n,t)=>{for(var i=t>1?void 0:t?fe(e,n):e,o=r.length-1,s;o>=0;o--)(s=r[o])&&(i=(t?s(e,n,i):s(i))||i);return t&&i&&X(e,n,i),i};var Z=navigator.userAgent.toLowerCase().indexOf("mac")!==-1;function ee(r){if(!r)return[];let e={backspace:"\u232B",shift:"\u21E7",meta:"\u2318",tab:"\u21B9",ctrl:"\u2303",arrowup:"\u2191",arrowdown:"\u2193",arrowleft:"\u2190",arrowright:"\u2192",enter:"\u23CE"};return r.toLowerCase().split("+").map(te).map(t=>Object.keys(e).includes(t)?e[t]:t)}a(ee,"bindingSymbols");function te(r){return!Z&&r==="meta"?"ctrl":r}a(te,"filterKeyForNonMacMeta");var F=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let n of this.bindings)if(n.command===e)return n;return null}evaluateEvent(e){e:for(let n of this.bindings){let t=n.key.toLowerCase().split("+");if(t.pop()===e.key.toLowerCase()){for(let o of["shift","ctrl","alt","meta"]){let s=t.includes(o);if(!Z){if(o==="meta")continue;o==="ctrl"&&(s=t.includes("meta")||t.includes("ctrl"))}let d=e[`${te(o)}Key`];if(!d&&s||d&&!s)continue e}return n}}return null}};a(F,"KeyBindings");var O=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...n){return new Promise(t=>{let i=this.commands[e].action(...n);t(i)})}};a(O,"CommandRegistry");var A=class{constructor(){this.menus={}}registerMenu(e,n){this.menus[e]=n}};a(A,"MenuRegistry");var E=class{constructor(e){this.commands=new O,this.keybindings=new F,this.menus=new A,this.backend=e,this.workspace=new D(e.files),this.context={node:null},this.panels=[[]]}get mainPanel(){return this.panels[0][0]}async initialize(){await this.workspace.load(),this.workspace.rawNodes.forEach(e=>this.backend.index.index(e)),this.workspace.observe(e=>{this.workspace.save(),e.isDestroyed?this.backend.index.remove(e.id):(this.backend.index.index(e.raw),e.components.forEach(n=>this.backend.index.index(n.raw)))}),this.workspace.lastOpenedID?this.openNewPanel(this.workspace.find(this.workspace.lastOpenedID)||this.workspace.mainNode()):this.openNewPanel(this.workspace.mainNode()),m.redraw(),localStorage.getItem("firsttime")||this.showNotice("firsttime")}authenticated(){return this.backend.auth&&this.backend.auth.currentUser()}closeQuickAdd(){this.quickadd=null,m.redraw()}openQuickAdd(){let e=this.workspace.find("@quickadd");e||(e=this.workspace.new("@quickadd")),this.quickadd=e}commitQuickAdd(){let e=this.workspace.find("@quickadd");if(!e)return;let n=this.todayNode();e.getChildren().forEach(t=>t.setParent(n))}clearQuickAdd(){let e=this.workspace.find("@quickadd");e&&e.getChildren().forEach(n=>n.destroy())}todayNode(){let e=new Date,n=e.toUTCString().split(e.getFullYear())[0],t=`Week ${String(ge(e)).padStart(2,"0")}`,o=["@workspace","Calendar",`${e.getFullYear()}`,t,n].join("/"),s=this.workspace.find(o);return s||(s=this.workspace.new(o)),s}openToday(){this.open(this.todayNode())}open(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new C(e);this.panels[0][0]=n,this.context.panel=n}openNewPanel(e){this.workspace.expanded[e.id]||(this.workspace.expanded[e.id]={}),this.workspace.lastOpenedID=e.id,this.workspace.save();let n=new C(e);this.panels[0].push(n),this.context.panel=n}closePanel(e){this.panels.forEach((n,t)=>{this.panels[t]=n.filter(i=>i!==e)})}defocus(){this.context.node=null}focus(e,n,t=0){this.context.node=e,n&&(this.context.panel=n);let i=this.getInput(e,n);i&&(i.focus(),t!==void 0&&i.setSelectionRange(t,t))}getInput(e,n){n||(n=this.context.panel);let t=`input-${n.id}-${e.id}`;return e.raw.Rel==="Fields"&&(t=t+"-value"),document.getElementById(t)}executeCommand(e,n,...t){return this.commands.executeCommand(e,this.newContext(n),...t)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,n){e.stopPropagation(),e.preventDefault();let t=e.target.closest("*[data-menu]"),i=t.getBoundingClientRect(),o=t.dataset.align||"left",s=document.body.scrollLeft+i.x;o==="right"&&(s=document.body.offsetWidth-i.right);let d=document.body.scrollTop+i.y+i.height,l=this.menus.menus[t.dataset.menu],u=l.filter(h=>h.command).map(h=>this.commands.commands[h.command]);l&&(this.menu={x:s,y:d,ctx:this.newContext(n),items:l,commands:u,align:o},this.curtain={visible:!1,onclick:()=>this.hideMenu()},m.redraw())}hideMenu(){this.menu=null,this.curtain=null,m.redraw()}showPalette(e,n,t){this.palette={x:e,y:n,ctx:t},this.curtain={visible:!1,onclick:()=>this.hidePalette()},m.redraw()}hidePalette(){this.palette=null,this.curtain=null,m.redraw()}showNotice(e,n){this.notice={message:e,finished:n},m.redraw()}hideNotice(){this.notice=null,m.redraw()}};a(E,"Workbench");function ge(r){var e=new Date(Date.UTC(r.getFullYear(),r.getMonth(),r.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);var t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}a(ge,"getWeekOfYear");var C=class{constructor(e){this.id=Math.random().toString(36).substring(2),this.history=[e]}open(e){this.history.push(e)}back(){this.history.pop()}get currentNode(){return this.history[this.history.length-1]}get headNode(){return this.history[0]}};a(C,"Panel");var K={};function x(r){K[N(r)]=r}a(x,"component");function N(r){return r.prototype===void 0&&(r=r.constructor),`treehouse.${r.name}`}a(N,"componentName");function Y(r){return typeof r=="string"?K[r]:K[N(r)]}a(Y,"getComponent");function ne(r,e){let n=new(Y(r));return n.fromJSON instanceof Function?n.fromJSON(e):Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),n}a(ne,"inflateToComponent");function T(r,e){return r.value&&r.value[e]instanceof Function}a(T,"hasHook");function I(r,e,...n){if(T(r,e))return r.value[e].apply(r.value,n)}a(I,"triggerHook");function $(r,e){for(let n of r.components)if(T(n,e))return!0;return!1}a($,"objectHas");function j(r,e,...n){for(let t of r.components)if(T(t,e))return t.value[e].apply(t.value,n)}a(j,"objectCall");var P=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}changed(e){this.observers.forEach(n=>n(e))}import(e){for(let n of e)n.Value&&Y(n.Name)&&(n.Value=ne(n.Name,n.Value),n.Rel="Components"),this.nodes[n.ID]=n;for(let n of e){if(n.Parent==="@tmp"){delete this.nodes[n.ID];continue}if(!n.ID.startsWith("@")&&n.Parent===void 0){delete this.nodes[n.ID];continue}if(n.Parent&&!this.nodes[n.Parent]){delete this.nodes[n.ID];continue}let t=this.find(n.ID);if(t){if(t.parent&&!t.parent.raw){delete this.nodes[n.ID];continue}I(t,"onAttach",t)}}}export(){let e=[];for(let n of Object.values(this.nodes))e.push(n);return e}make(e,n){let t=null;if(e.includes("/")){let s=e.split("/");t=this.root(s[0]);for(let d=1;d<s.length-1;d++){if(t===null)throw"unable to get root";let l=t.find(s[d]);l||(l=this.make(s.slice(0,d+1).join("/"))),t=l}e=s[s.length-1]}let i=e.startsWith("@")?e:we();this.nodes[i]={ID:i,Name:e,Value:n,Linked:{Children:[],Components:[]},Attrs:{}};let o=new k(this,i);return t&&(o.parent=t),o}destroy(e){let n=e.parent;if(n!==null&&!n.isDestroyed){let t=e.raw.Rel||"Children";n.raw.Linked[t].includes(e.id)&&n.raw.Linked[t].splice(e.siblingIndex,1)}delete this.nodes[e.id],n&&this.changed(n)}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new k(this,e.ID))}root(e){e=e||"@root";let n=this.roots().find(t=>t.name===e);return n===void 0?null:n}find(e){let n=this.nodes[e];if(n)return new k(this,n.ID);let t=e.split("/");if(t.length===1&&t[0].startsWith("@"))return null;let i=this.root(t[0]);if(i?t.shift():i=this.root("@root"),!i)return null;let o=a((s,d)=>(s.refTo&&(s=s.refTo),s.children.find(l=>l.name===d)),"findChild");for(let s of t){let d=o(i,s);if(!d)return null;i=d}return i}walk(e,n){for(let t of this.roots())if(t.walk(e,n))return}observe(e){this.observers.push(e)}};a(P,"Bus");var we=a(()=>{let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e},"uniqueId");var k=class{constructor(e,n){this._bus=e,this._id=n}[Symbol.for("Deno.customInspect")](){return`Node[${this.id}:${this.name}]`}get id(){return this._id}get bus(){return this._bus}get raw(){let e=this._bus.nodes[this.id];if(!e)throw`use of non-existent node ${this.id}`;return e}get name(){return this.refTo?this.refTo.name:this.raw.Name}set name(e){this.refTo?this.refTo.name=e:this.raw.Name=e,this.changed()}get value(){return this.refTo?this.refTo.value:this.raw.Value}set value(e){this.refTo?this.refTo.value=e:this.raw.Value=e,this.changed()}get parent(){return!this.raw.Parent||!this._bus.nodes[this.raw.Parent]?null:new k(this._bus,this.raw.Parent)}set parent(e){let n=this.parent;n!==null&&n.raw.Linked.Children.splice(this.siblingIndex,1),e!==null?(this.raw.Parent=e.id,e.raw.Linked.Children.push(this.id),I(e,"onAttach",e)):this.raw.Parent=void 0,this.changed()}get refTo(){let e=this.raw.Attrs.refTo;return!e||!this._bus.nodes[e]?null:new k(this._bus,e)}set refTo(e){if(!e){delete this.raw.Attrs.refTo,this.changed();return}this.raw.Attrs.refTo=e.id,this.changed()}get siblingIndex(){let e=this.parent;if(e===null)return 0;let n=this.raw.Rel||"Children";return e.raw.Linked[n].findIndex(t=>t===this.id)}set siblingIndex(e){let n=this.parent;if(n===null)return;let t=this.raw.Rel||"Children";n.raw.Linked[t].splice(this.siblingIndex,1),n.raw.Linked[t].splice(e,0,this.id),n.changed()}get prevSibling(){let e=this.parent;if(e===null||this.siblingIndex===0)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex-1]}get nextSibling(){let e=this.parent;if(e===null||this.siblingIndex===e.children.length-1)return null;let n=this.raw.Rel||"Children";return e.getLinked(n)[this.siblingIndex+1]}get ancestors(){let e=[],n=this.parent;for(;n!==null;)e.push(n),n=n.parent;return e}get isDestroyed(){return!this._bus.nodes.hasOwnProperty(this.id)}get path(){let e=this,n=[];for(;e;)n.unshift(e.name),e=e.parent;return n.join("/")}get children(){if(this.refTo)return this.refTo.children;let e=[];this.raw.Linked.Children&&(e=this.raw.Linked.Children.map(n=>new k(this._bus,n)));for(let n of this.components)if(T(n,"objectChildren"))return I(n,"objectChildren",this,e);return e}get childCount(){if(this.refTo)return this.refTo.childCount;for(let e of this.components)if(T(e,"objectChildren"))return I(e,"objectChildren",this,null).length;return this.raw.Linked.Children?this.raw.Linked.Children.length:0}addChild(e){if(this.refTo){this.refTo.addChild(e);return}this.raw.Linked.Children.push(e.id),this.changed()}removeChild(e){if(this.refTo){this.refTo.removeChild(e);return}let n=this.raw.Linked.Children.filter(t=>t===e.id);this.raw.Linked.Children=n,this.changed()}get components(){return this.raw.Linked.Components?this.raw.Linked.Components.map(e=>new k(this._bus,e)):[]}get componentCount(){return this.raw.Linked.Components?this.raw.Linked.Components.length:0}addComponent(e){let n=this.bus.make(N(e),e);n.raw.Parent=this.id,n.raw.Rel="Components",this.raw.Linked.Components.push(n.id),I(n,"onAttach",n),this.changed()}removeComponent(e){let n=this.components.filter(t=>t.name===N(e));n.length>0&&n[0].destroy(),this.changed()}hasComponent(e){return this.components.filter(t=>t.name===N(e)).length>0}getComponent(e){let n=this.components.filter(t=>t.name===N(e));return n.length>0?n[0].value:null}getLinked(e){return this.raw.Linked[e]?this.raw.Linked[e].map(n=>new k(this._bus,n)):[]}addLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]),n.raw.Rel=e,this.raw.Linked[e].push(n.id),this.changed()}removeLinked(e,n){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let t=this.raw.Linked[e].filter(i=>i===n.id);this.raw.Linked[e]=t,this.changed()}moveLinked(e,n,t){this.raw.Linked[e]||(this.raw.Linked[e]=[]);let i=this.raw.Linked[e].findIndex(s=>s===n.id);if(i===-1)return;let o=this.raw.Linked[e];o.splice(t,0,o.splice(i,1)[0]),this.raw.Linked[e]=o,this.changed()}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,n){this.raw.Attrs[e]=n,this.changed()}find(e){return this.bus.find([this.path,e].join("/"))}walk(e,n){if(n=n||{followRefs:!1,includeComponents:!1},e(this))return!0;let t=this.children;if(this.refTo&&n.followRefs){if(e(this.refTo))return!0;t=this.refTo.children}for(let i of t)if(i.walk(e,n))return!0;if(n.includeComponents){for(let i of this.components)if(i.walk(e,n))return!0}return!1}destroy(){if(this.isDestroyed)return;if(this.refTo){this._bus.destroy(this);return}let e=[];this.walk(n=>(e.push(n),!1),{followRefs:!1,includeComponents:!0}),e.reverse().forEach(n=>this._bus.destroy(n))}changed(){this._bus.changed(this)}};a(k,"Node");var D=class{constructor(e){this.fs=e,this.bus=new P,this.expanded={},this.writeDebounce=ve(async(n,t)=>{try{await this.fs.writeFile(n,t),console.log("Saved workspace.")}catch(i){console.error(i),document.dispatchEvent(new CustomEvent("BackendError"))}})}get rawNodes(){return this.bus.export()}observe(e){this.bus.observe(e)}save(){this.writeDebounce("workspace.json",JSON.stringify({version:1,lastopen:this.lastOpenedID,expanded:this.expanded,nodes:this.rawNodes},null,2))}async load(){let e=JSON.parse(await this.fs.readFile("workspace.json")||"{}");Array.isArray(e)&&(e={version:0,nodes:e}),e.nodes&&(this.bus.import(e.nodes),console.log(`Loaded ${e.nodes.length} nodes.`)),e.expanded&&(this.expanded=e.expanded),e.lastopen&&(this.lastOpenedID=e.lastopen)}mainNode(){let e=this.bus.find("@workspace");if(!e){console.info("Building missing workspace node.");let n=this.bus.find("@root"),t=this.bus.make("@workspace");t.name="Workspace",t.parent=n;let i=this.bus.make("@calendar");i.name="Calendar",i.parent=t;let o=this.bus.make("Home");o.parent=t,e=t}return e}find(e){return this.bus.find(e)}new(e,n){return this.bus.make(e,n)}getExpanded(e,n){this.expanded[e.id]||(this.expanded[e.id]={});let t=this.expanded[e.id][n.id];return t===void 0&&(t=!1),t}setExpanded(e,n,t){this.expanded[e.id][n.id]=t,this.save()}findAbove(e,n){if(n.id===e.id)return null;let t=n.prevSibling;if(!t)return n.parent;let i=a(o=>{if(!this.getExpanded(e,o)||o.childCount===0)return o;let d=o.children[o.childCount-1];return i(d)},"lastChildIfExpanded");return i(t)}findBelow(e,n){if(this.getExpanded(e,n)&&n.getLinked("Fields").length>0)return n.getLinked("Fields")[0];if(this.getExpanded(e,n)&&n.childCount>0)return n.children[0];let t=a(i=>{let o=i.nextSibling;if(o)return o;let s=i.parent;return!s||s.id===e.id?null:i.raw.Rel==="Fields"&&s.childCount>0?s.children[0]:t(s)},"nextSiblingOrParentNextSibling");return t(n)}};a(D,"Workspace");function ve(r,e=3e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(ve,"debounce");var ie={view({attrs:{workbench:r,x:e,y:n,items:t,align:i,commands:o,ctx:s}}){let d=a((u,h)=>f=>{f.stopPropagation(),!u.disabled&&(u.onclick&&u.onclick(),h&&r.executeCommand(h.id,s),r.hideMenu())},"onclick"),l={left:`${e}px`};return i==="right"&&(l={right:`${e}px`}),m("ul",{class:"menu",style:Object.assign(l,{margin:"0",position:"absolute",top:`${n}px`,display:"inline-block"})},t.filter(u=>!u.when||u.when()).map(u=>{let h="",f,g;return u.command&&(g=o.find(p=>p.id===u.command),f=r.keybindings.getBinding(g.id),h=g.title),u.title&&(h=u.title()),m("li",{onclick:d(u,g),class:u.disabled?"disabled":"",style:{display:"flex"}},m("div",null,h),f&&m("div",{class:"keybindings grow text-right"},ee(f.key).join(" ").toUpperCase()))}))}};var oe={onupdate({state:r,dom:e}){let n=e.querySelector(".commands").children;r.selected!==void 0&&n.length>0&&n[r.selected].scrollIntoView({block:"nearest"})},oncreate({dom:r}){r.querySelector("input").focus()},view({attrs:r,state:e}){let n=r.workbench;e.filter=e.filter===void 0?"":e.filter;let i=Object.values(n.commands.commands).filter(d=>d.id.startsWith(e.filter)),o=a(d=>{let l=a((u,h)=>(u%h+h)%h,"mod");if(d.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=l(e.selected+1,i.length),!1}if(d.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=l(e.selected-1,i.length),!1;if(d.key==="Enter")return e.selected!==void 0&&(n.commands.executeCommand(i[e.selected].id,r.ctx),n.hidePalette()),!1},"onkeydown"),s=a(d=>{e.filter=d.target.value,e.selected=0},"autocomplete");return m("div",{class:"palette",style:{position:"absolute",left:`${r.x}px`,top:`${r.y}px`}},m("div",null,m("input",{style:{width:"98%",outline:"0",border:"0"},type:"text",onkeydown:o,oninput:s,placeholder:"Enter command..."})),m("div",{class:"commands",style:{overflowY:"scroll",position:"relative"}},i.map((d,l)=>m("div",{class:e.selected===l?"selected":""},d.title||d.id))))}};var w=class{constructor(){this.checked=!1}editor(){return ye}};a(w,"Checkbox"),w=y([x],w);var ye={view({attrs:r}){let{node:e,panel:n,workbench:t}=r;return m("input",{type:"checkbox",style:{marginTop:"0.3rem",marginRight:"0.5rem"},onclick:a(o=>{let s=e.getComponent(w);s.checked=!s.checked,e.changed()},"toggleCheckbox"),checked:e.getComponent(w).checked})}};var q={view({attrs:{workbench:r,panel:e,node:n}}){return m("div",{class:"new-node flex flex-row items-center"},m("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7"}),m("path",{style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{class:"flex grow"},m("input",{class:"grow",type:"text",oninput:a(o=>{r.executeCommand("insert-child",{node:n,panel:e},o.target.value)},"startNew"),onkeydown:a(o=>{if(o.key==="Tab"&&(o.stopPropagation(),o.preventDefault(),n.childCount>0)){let s=n.children[n.childCount-1];r.executeCommand("insert-child",{node:s,panel:e})}},"tabNew"),value:""})))}};var b={view({attrs:{workbench:r,node:e,panel:n,onkeydown:t,disallowEmpty:i,editValue:o},state:s}){let d=o?"value":"name",l=a(()=>d==="name"?$(e,"displayName")?j(e,"displayName",e):e.name:e[d]||"","display"),u=a(()=>{s.initialValue=e[d],r.context.node=e},"onfocus"),h=a(()=>e[d],"getter"),f=a((p,_)=>{e.isDestroyed||(i&&p.length===0?e[d]=s.initialValue:e[d]=p),_&&(r.context.node=null)},"setter"),g=`input-${n.id}-${e.id}`;return d==="value"&&(g=g+"-value"),m(xe,{id:g,getter:h,setter:f,display:l,onkeydown:t,onfocus:u})}},xe={oncreate({dom:r,attrs:e}){let n=r.querySelector("textarea"),t=n.offsetHeight,i=r.querySelector("span");this.updateHeight=()=>{i.style.width=`${Math.max(n.offsetWidth,100)}px`,i.innerHTML=n.value.replace(`
`,"<br/>"),n.style.height=i.offsetHeight>0?`${i.offsetHeight}px`:`${t}px`},n.addEventListener("input",()=>this.updateHeight()),n.addEventListener("blur",()=>i.innerHTML=""),setTimeout(()=>this.updateHeight(),50),e.onmount&&e.onmount(n)},onupdate(){this.updateHeight()},view({attrs:{id:r,onkeydown:e,onfocus:n,onblur:t,getter:i,setter:o,display:s},state:d}){let l=d.editing?d.buffer:s?s():i();return m("div",{class:"node-container"},m("textarea",{id:r,rows:"1",onfocus:a(p=>{n&&n(p),d.editing=!0,d.buffer=i()},"startEdit"),onblur:a(p=>{d.editing&&(d.editing=!1,o(d.buffer,!0),d.buffer=void 0),t&&t(p)},"finishEdit"),oninput:a(p=>{d.buffer=p.target.value,o(d.buffer,!1)},"edit"),onkeydown:e||a(p=>{p.key==="Enter"&&(p.preventDefault(),p.stopPropagation())},"defaultKeydown"),value:l},l),m("span",{style:{visibility:"hidden",position:"fixed"}}))}};var re={view({attrs:{node:r,workbench:e,panel:n}}){return m("div",{class:"empty-view"})}};var se={view({attrs:{node:r,workbench:e,panel:n}}){return m("div",{class:"list-view"},m("div",{class:"fields"},r.getLinked("Fields").length>0&&r.getLinked("Fields").map(t=>m(B,{key:t.id,workbench:e,panel:n,node:t}))),m("div",{class:"children"},r.childCount>0?r.children.map(t=>m(B,{key:t.id,workbench:e,panel:n,node:t})):m(q,{workbench:e,panel:n,node:r})))}};var ae={view({attrs:{node:r,workbench:e,panel:n},state:t}){t.fields=t.fields===void 0?new Set:t.fields,r.children.forEach(o=>{o.getLinked("Fields").forEach(s=>t.fields.add(s.name))});let i=a((o,s)=>{let d=o.getLinked("Fields").filter(l=>l.name===s);return d.length===0?"":m(b,{editValue:!0,workbench:e,panel:n,node:d[0]})},"getFieldEditor");return m("table",{class:"table-view",style:{gridTemplateColumns:`repeat(${t.fields.size+1}, 1fr)`}},m("thead",null,m("tr",null,m("th",null),[...t.fields].map(o=>m("th",null,o)))),m("tbody",null,r.children.map(o=>m("tr",null,m("td",null,m(B,{key:o.id,workbench:e,panel:n,node:o})),[...t.fields].map(s=>m("td",null,i(o,s)))))))}};function de(r){return{list:se,table:ae}[r]||re}a(de,"getView");var U={view({attrs:{workbench:r,panel:e,node:n},state:t}){return m("div",null,n.children.map(i=>m(B,{key:i.id,workbench:r,panel:e,node:i})),m(q,{workbench:r,panel:e,node:n}))}},B={view({attrs:r,state:e,children:n}){let{node:t,panel:i,workbench:o}=r,s=!1,d=t;t.refTo&&(s=!0,t=d.refTo);let l=o.workspace.getExpanded(i.headNode,d),u=a(c=>{e.hover=!0,c.stopPropagation()},"hover"),h=a(c=>{e.hover=!1,c.stopPropagation()},"unhover"),f=a(c=>{l?o.executeCommand("collapse",{node:d,panel:i}):o.executeCommand("expand",{node:d,panel:i}),c.stopPropagation()},"toggle"),g=a(c=>{let G=c.shiftKey||c.metaKey||c.altKey||c.ctrlKey;switch(c.key){case"ArrowUp":c.target.selectionStart!==0&&!G&&c.stopPropagation();break;case"ArrowDown":c.target.selectionStart!==c.target.value.length&&c.target.selectionStart!==0&&!G&&c.stopPropagation();break;case"Backspace":if(c.target.value===""){if(c.preventDefault(),c.stopPropagation(),t.childCount>0)return;o.executeCommand("delete",{node:t,panel:i,event:c});return}if(c.target.value!==""&&c.target.selectionStart===0&&c.target.selectionEnd===0){c.preventDefault(),c.stopPropagation();let H=o.workspace.findAbove(i.headNode,t);if(!H)return;let J=H.name;H.name=J+c.target.value,t.destroy(),m.redraw.sync(),o.focus(H,i,J.length);return}break;case"Enter":if(c.preventDefault(),c.ctrlKey||c.shiftKey||c.metaKey||c.altKey)return;if(c.target.selectionStart===c.target.value.length){t.childCount>0&&o.workspace.getExpanded(i.headNode,t)?o.executeCommand("insert-child",{node:t,panel:i},"",0):o.executeCommand("insert",{node:t,panel:i}),c.stopPropagation();return}if(c.target.selectionStart===0){o.executeCommand("insert-before",{node:t,panel:i}),c.stopPropagation();return}if(c.target.selectionStart>0&&c.target.selectionStart<c.target.value.length){o.executeCommand("insert",{node:t,panel:i},c.target.value.slice(c.target.selectionStart)).then(()=>{t.name=c.target.value.slice(0,c.target.selectionStart)}),c.stopPropagation();return}break}},"checkCommands"),p=a(c=>{c.preventDefault(),c.stopPropagation(),o.executeCommand("open",{node:t,panel:i}),document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},"open"),_=a(c=>c.childCount+c.getLinked("Fields").length,"subCount");return m("div",{onmouseover:u,onmouseout:h},m("div",{class:"node-row-outer-wrapper flex flex-row items-start"},m("svg",{class:"node-menu shrink-0",xmlns:"http://www.w3.org/2000/svg",style:{display:e.hover?"block":"none"},onclick:c=>o.showMenu(c,{node:d,panel:i}),oncontextmenu:c=>o.showMenu(c,{node:d,panel:i}),"data-menu":"node",viewBox:"0 0 16 16"},m("path",{style:{transform:"translateY(-1px)"},"fill-rule":"evenodd",d:"M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"})),m("div",{class:"node-handle shrink-0",onclick:f,ondblclick:p,oncontextmenu:c=>o.showMenu(c,{node:d,panel:i}),"data-menu":"node"},$(t,"handleIcon")?j(t,"handleIcon"):m("svg",{class:"node-bullet",viewBox:"0 0 16 16",xmlns:"http://www.w3.org/2000/svg"},_(t)>0&&!l?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"}),",",s?m("circle",{cx:"8",cy:"7",r:"7",fill:"none",stroke:"gray","stroke-width":"1","stroke-dasharray":"3,3"}):null)),t.raw.Rel==="Fields"?m("div",{class:"flex grow items-start flex-row"},m("div",null,m(b,{workbench:o,panel:i,node:t,onkeydown:g})),m(b,{editValue:!0,workbench:o,panel:i,node:t,onkeydown:g})):m("div",{class:"flex grow items-start flex-row"},t.hasComponent(w)&&m(j(t,"editor"),{node:t}),m(b,{workbench:o,panel:i,node:t,onkeydown:g}))),l===!0&&m("div",{class:"expanded-node flex flex-row"},m("div",{class:"indent flex",onclick:f}),m("div",{class:"view grow"},m(de(t.getAttr("view")||"list"),{workbench:o,panel:i,node:t}))))}};var v=class{constructor(){this.markdown=""}};a(v,"Page"),v=y([x],v);var le={view({attrs:r}){let e=r.panel,n=r.workbench,t=e.currentNode,i=a(u=>{n.executeCommand("close-panel",{},e)},"close"),o=a(u=>{e.back()},"goBack"),s=a(u=>{n.panels=[[e]],n.context.panel=e},"maximize"),d=a(u=>{t.getComponent(v).markdown=u.target.value,t.changed()},"editMarkdown");function l(u=""){return 20+(u.match(/\n/g)||[]).length*20}return a(l,"calcHeight"),m("div",{class:"panel flex flex-col grow"},m("div",{class:"bar flex"},e.history.length>1?m("div",{class:"panel-back",style:{rightPadding:"var(--padding)"}},m("svg",{onclick:o,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{"fill-rule":"evenodd",d:"M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"}))):null,m("div",{class:"panel-back-parent grow"},t.parent&&t.parent.id!=="@root"?m("span",{style:{cursor:"pointer"},onclick:()=>n.open(t.parent)},t.parent.name):m("span",null,"/")),n.panels.flat().length>1?m("div",{class:"panel-icons flex items-center"},m("svg",{onclick:s,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-maximize-2"},m("polyline",{points:"15 3 21 3 21 9"}),m("polyline",{points:"9 21 3 21 3 15"}),m("line",{x1:"21",y1:"3",x2:"14",y2:"10"}),m("line",{x1:"3",y1:"21",x2:"10",y2:"14"})),m("svg",{onclick:i,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-x"},m("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),m("line",{x1:"6",y1:"6",x2:"18",y2:"18"}))):null),m("div",{class:"body flex flex-col"},m("div",{class:"title-node",oncontextmenu:u=>n.showMenu(u,{node:t,panel:e}),"data-menu":"node"},m(b,{workbench:n,panel:e,node:t,disallowEmpty:!0})),t.hasComponent(v)?m("textarea",{oninput:d,value:t.getComponent(v).markdown,placeholder:"Enter Markdown text here",style:{marginLeft:"var(--padding)",padding:"var(--padding)",outline:"0",height:`${l(t.getComponent(v).markdown)}px`,border:"0"}},t.getComponent(v).markdown):null,m(U,{workbench:n,panel:e,node:t})))}};var ce={view({attrs:{workbench:r}}){let e={id:"quickadd",headNode:r.quickadd};return m("div",{style:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0"}},m("div",{onclick:()=>r.closeQuickAdd(),style:{position:"absolute",background:"black",opacity:"50%",width:"100%",height:"100%"}}),m("div",{class:"notice",style:{position:"relative",marginLeft:"auto",marginRight:"auto",marginTop:"20vh"}},m("h3",null,"Quick Add"),m(U,{workbench:r,node:r.quickadd,panel:e}),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{r.commitQuickAdd(),r.closeQuickAdd()}},"Add to Today"))))}};var ue={onupdate({state:r,dom:e}){let n=e.querySelector(".results");n&&r.selected!==void 0&&n.children.length>0&&n.children[r.selected].scrollIntoView({block:"nearest"})},view({attrs:{workbench:r},state:e}){e.query=e.query===void 0?"":e.query,e.results=e.results===void 0?[]:e.results;let n=a(()=>{e.query="",e.results=[],r.curtain=null},"clear"),t=a(s=>{r.open(s),n()},"open"),i=a(s=>{let d=a((l,u)=>(l%u+u)%u,"mod");if(s.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=d(e.selected+1,e.results.length),!1}if(s.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=d(e.selected-1,e.results.length),!1;if(s.key==="Enter")return e.selected!==void 0&&t(e.results[e.selected]),!1;s.key==="Escape"&&n()},"onkeydown"),o=a(s=>{if(e.query=s.target.value,e.selected=0,e.query){let d=e.query.split(/[ ]+/),l=d.filter(h=>!h.includes(":")).join(" "),u=Object.fromEntries(d.filter(h=>h.includes(":")).map(h=>h.toLowerCase().split(":")));!l&&Object.keys(u).length>0&&(l=Object.keys(u)[0]),e.results=r.backend.index.search(l).map(h=>{let f=r.workspace.find(h);if(f&&!(f.value&&(f=f.parent,!f.raw))){if(Object.keys(u).length>0){let g={};for(let p of f.getLinked("Fields"))g[p.name.toLowerCase()]=p.value.toLowerCase();for(let p in u)if(!g[p]||g[p]!==u[p])return}return f}}).filter(h=>h!==void 0)}else e.results=[];e.query&&e.results.length>0?r.curtain={visible:!1,onclick:()=>n()}:r.curtain=null},"autocomplete");return m("div",{class:e.results.length>0?"search active flex grow":"search flex grow"},m("div",null,m("div",{class:"flex",style:{margin:e.results.length>0?"0":"1px"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-search shrink-0"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})),m("input",{type:"text",placeholder:"Search",value:e.query,onkeydown:i,oninput:o,style:{border:"0",outline:"0",background:"transparent",paddingTop:"3px"}})),e.results.length>0?m("div",{class:"results",style:{overflowX:"hidden",overflowY:"auto",maxHeight:"400px"}},e.results.map((s,d)=>m("div",{onclick:()=>t(s),class:e.selected===d?"selected":""},s.name))):null))}};var be={view({attrs:{workbench:r,finished:e}}){return m("div",null,m("h3",null,"Refresh to view latest updates"),m("p",null,"Your notes were updated in another browser session. Refresh the page to view the latest version."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{e()}},"Refresh Now")))}},Ce={view({attrs:{workbench:r}}){return m("div",null,m("h3",null,"Treehouse is under active development"),m("p",null,"This is a preview based on our main branch, which is actively being developed."),m("p",null,"If you find a bug, please report it via [ ",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.25rem",marginRight:"0.25rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}))," > Submit Issue ]."),m("p",null,"Data is stored using localstorage, which you can reset via [ ",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.25rem",marginRight:"0.25rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}))," > Reset Demo ]."),m("div",{class:"button-bar"},m("button",{class:"primary",onclick:()=>{localStorage.setItem("firsttime","1"),r.hideNotice()}},"Got it")))}},Ne={view({attrs:{workbench:r,finished:e}}){return m("div",null,m("h3",null,"Login with GitHub"),m("p",null,"The GitHub backend is experimental so use at your own risk!"),m("p",null,"To store your workbench we will create a public repository called ",m("pre",{style:{display:"inline"}},"<username>.treehouse.sh")," if it doesn't already exist. You can manually make this repository private via GitHub if you want."),m("p",null,"You can Logout via the",m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{display:"inline",marginLeft:"0.5rem",marginRight:"0.5rem"},width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"})),"menu in the top right to return to the localstorage backend."),m("div",{class:"button-bar"},m("button",{onclick:()=>{r.hideNotice()}},"Cancel"),m("button",{class:"primary",onclick:()=>{r.hideNotice(),localStorage.setItem("github","1"),e()}},"Log in with GitHub")))}},he={view({attrs:{workbench:r,message:e,finished:n}}){return m("div",{style:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0"}},m("div",{style:{position:"absolute",background:"black",opacity:"50%",width:"100%",height:"100%"}}),m("div",{class:"notice",style:{position:"relative",marginLeft:"auto",marginRight:"auto",filter:"drop-shadow(2px 2px 4px #5555)",marginTop:"20vh"}},m({firsttime:Ce,github:Ne,lockstolen:be}[e],{workbench:r,finished:n})))}};var pe={view({attrs:{workbench:r},state:e}){e.open=e.open===void 0?!0:e.open;let n=a(t=>{e.open?e.open=!1:e.open=!0},"toggle");return m("main",{class:"workbench m-0 flex flex-row absolute inset-0",style:{overflow:"none"}},m("div",{class:"sidebar flex flex-col",style:{width:e.open?"256px":"52px"}},m("div",{class:"sidebar-topsection",style:{height:"56px"}},m("img",{class:"logo",src:"/icon_transparent.png",style:{width:"20px",height:"20px"}})),m("div",{class:"grow sidebar-maincontent"},e.open&&r.workspace.bus.root().children.map(t=>m(me,{node:t,expanded:!0,level:0,workbench:r}))),m("div",{class:"sidebar-bottomsection"},m("svg",{onclick:n,xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-sidebar"},m("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"9",y1:"3",x2:"9",y2:"21"})))),m("div",{class:"main flex flex-col grow"},m("div",{class:"topbar flex"},m("div",{class:"topbar-item",onclick:()=>r.openToday(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-calendar"},m("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),m("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),m("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),m("line",{x1:"3",y1:"10",x2:"21",y2:"10"})),m("div",null,"Today")),m("div",{class:"topbar-item",onclick:()=>r.openQuickAdd(),style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{style:{marginRight:"var(--1)"},xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},m("circle",{cx:"12",cy:"12",r:"10"}),m("line",{x1:"12",y1:"8",x2:"12",y2:"16"}),m("line",{x1:"8",y1:"12",x2:"16",y2:"12"})),m("div",null,"Quick Add")),m(ue,{workbench:r}),m("div",{onclick:t=>r.showMenu(t),"data-menu":"settings","data-align":"right",style:{cursor:"pointer",marginLeft:"var(--padding)",marginRight:"var(--padding)"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-menu"},m("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),m("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),m("line",{x1:"3",y1:"18",x2:"21",y2:"18"})))),m("div",{class:"panels flex flex-row",style:{position:"relative",overflow:"hidden"}},r.panels.map(t=>t.map(i=>m("div",{style:{flex:"1 1 auto",overflowY:"auto"}},m(le,{workbench:r,panel:i})))))),r.curtain&&m("div",{onclick:r.curtain.onclick,style:{zIndex:"10",position:"absolute",background:"black",opacity:r.curtain.visible?"50%":"0%",width:"100%",height:"100%"}}),r.menu&&m(ie,{workbench:r,...r.menu}),r.palette&&m(oe,{workbench:r,...r.palette}),r.quickadd&&m(ce,{workbench:r}),r.notice&&m(he,{workbench:r,...r.notice}))}},me={view({attrs:{node:r,workbench:e,expanded:n,level:t},state:i}){i.expanded=i.expanded===void 0?n:i.expanded;let o=r.childCount>0&&t<3,s=a(l=>{o&&(i.expanded?i.expanded=!1:i.expanded=!0,l.stopPropagation())},"toggle"),d=a(l=>{e.open(r)},"open");return m("div",null,m("div",{style:{display:"flex",paddingBottom:"var(--2)"}},m("svg",{onclick:s,style:{cursor:"pointer",flexShrink:"0",paddingTop:"0px",marginRight:"0.125rem"},class:"feather feather-chevron-right",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",xmlns:"http://www.w3.org/2000/svg"},o?i.expanded?m("polyline",{points:"6 9 12 15 18 9"}):m("polyline",{points:"9 18 15 12 9 6"}):null),m("div",{onclick:d,style:{cursor:"pointer",lineHeight:"1.25",fontSize:"0.875rem",flexGrow:"1",maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},r.name)),i.expanded&&m("div",{style:{marginLeft:"0.5rem"}},r.children.filter(l=>l.name!=="").map(l=>m(me,{workbench:e,node:l,level:t+1}))))}};function Ie(r,e=1e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{r.apply(this,t)},e)}}a(Ie,"debounce");var L=class{constructor(){this.index=window.workbench.backend.index,this.searchDebounce=Ie(this.search.bind(this))}handleIcon(){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("circle",{cx:"11",cy:"11",r:"8"}),m("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"}))}displayName(e){return`Search for "${e.name}"`}onAttach(e){this.component=e,this.object=e.parent,e.bus.observe(n=>{e.isDestroyed||this.searchDebounce()})}search(){if(console.log("searched"),!this.object)return;let e=this.object.name,n=e.split(/[ ]+/),t=n.filter(s=>!s.includes(":")).join(" "),i=Object.fromEntries(n.filter(s=>s.includes(":")).map(s=>s.toLowerCase().split(":")));!t&&Object.keys(i).length>0&&(t=Object.keys(i)[0]);let o=this.index.search(t).map(s=>{let d=window.workbench.workspace.find(s);if(d&&!(d.value&&(d=d.parent,!d.raw))){if(Object.keys(i).length>0){let l={};for(let u of d.getLinked("Fields"))l[u.name.toLowerCase()]=u.value.toLowerCase();for(let u in i)if(!l[u]||l[u]!==i[u])return}return d}}).filter(s=>s!==void 0).filter(s=>s.id!==this.object.id&&s.id!==this.component.id);(o.length!==this.lastResultCount||e!==this.lastQuery)&&(this.results&&this.results.forEach(s=>s.destroy()),this.results=o.map(s=>{let d=this.object.bus.make("");return d.raw.Parent="@tmp",d.refTo=s,d}),this.lastQuery=e,this.lastResultCount=o.length)}objectChildren(e,n){return this.results||this.search(),this.results}toJSON(e){return{}}fromJSON(e){}};a(L,"SearchNode"),L=y([x],L);var S=class{constructor(){}handleIcon(){return m("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},m("polyline",{points:"4 7 4 4 20 4 20 7"}),m("line",{x1:"9",y1:"20",x2:"15",y2:"20"}),m("line",{x1:"12",y1:"4",x2:"12",y2:"20"}))}};a(S,"TextField"),S=y([x],S);var R=class{constructor(){this.auth=null,this.files=new z,window.MiniSearch?this.index=new M:this.index=new W}};a(R,"BrowserBackend");var M=class{constructor(){this.indexer=new MiniSearch({idField:"ID",fields:["ID","Name","Value","Value.markdown"],storeFields:["ID"],extractField:(e,n)=>n.split(".").reduce((t,i)=>t&&t[i],e)})}index(e){this.indexer.has(e.ID)?this.indexer.replace(e):this.indexer.add(e)}remove(e){try{this.indexer.discard(e)}catch{}}search(e){let n=this.indexer.autoSuggest(e);return n.length===0?[]:this.indexer.search(n[0].suggestion,{prefix:!0}).map(t=>t.ID)}};a(M,"SearchIndex_MiniSearch");var W=class{constructor(){this.nodes={}}index(e){this.nodes[e.ID]=e.Name}remove(e){delete this.nodes[e]}search(e){let n=[];for(let t in this.nodes)this.nodes[t].includes(e)&&n.push(t);return n}};a(W,"SearchIndex_Dumb");var z=class{async readFile(e){return localStorage.getItem(`treehouse:${e}`)}async writeFile(e,n){localStorage.setItem(`treehouse:${e}`,n)}};a(z,"FileStore");import{encode as Le,decode as Se}from"https://cdn.jsdelivr.net/npm/js-base64@3.7.5/base64.mjs";var Q=class{constructor(e,n,t){this.loginURL=e,this.clientFactory=n,this.auth=this,this.shas={},this.opts=Object.assign({domain:"treehouse.sh",checkDomain:!1},t||{});let i=new R;this.index=i.index,this.files=i.files}get repo(){return`${this.user?.userID()}.${this.opts.domain}`}async initialize(){let e=new URL(location.href).searchParams.get("code");if(e)try{let o=location.search.replace(/\bcode=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${o}`);let d=await(await fetch(this.loginURL,{method:"POST",mode:"cors",headers:{"content-type":"application/json"},body:JSON.stringify({code:e})})).json();if(d.error)throw d.error;localStorage.setItem("treehouse:gh-token",d.token)}catch(o){this.reset(),console.error(o);return}let n=new URL(location.href).searchParams.get("access_token");if(n)try{let o=location.search.replace(/\baccess_token=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${o}`),localStorage.setItem("treehouse:gh-token",n)}catch(o){this.reset(),console.error(o);return}try{if(await this.authenticate(),!this.user)throw"authentication failed"}catch(o){console.error(o),this.opts.authFallbackURL&&(location.href=this.opts.authFallbackURL);return}if(this.opts.checkDomain&&this.repo!==location.hostname){location.hostname=this.repo;return}try{await this.client.rest.repos.get({owner:this.user.userID(),repo:this.repo})}catch(o){if(o.message!=="Not Found")throw o;console.log("Creating repository...");let s=await this.client.rest.repos.createForAuthenticatedUser({name:this.repo});if(s.status!==201){console.error(s);return}}try{await this.client.rest.repos.getContent({owner:this.user.userID(),repo:this.repo,path:"workspace.json"})}catch(o){if(o.name!=="HttpError")throw o;console.log("Creating workspace.json...");let s=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user.userID(),repo:this.repo,path:"workspace.json",message:"initial commit",content:btoa(JSON.stringify([]))});if(s.status!==201){console.error(s);return}}this.files=this;let t=Ee();await this.readFile("treehouse.lock"),await this.writeFile("treehouse.lock",t);let i=setInterval(async()=>{await this.readFile("treehouse.lock")!==t&&(clearInterval(i),document.dispatchEvent(new CustomEvent("BackendError")),console.warn("lock stolen!"))},5e3)}async authenticate(){let e=localStorage.getItem("treehouse:gh-token");if(!e)return;this.client=new this.clientFactory({auth:e});let n=await this.client.rest.users.getAuthenticated();!n||n.error||(this.user=new V(n.data),m&&m.redraw())}currentUser(){return this.user}login(){location.assign(this.loginURL)}reset(){localStorage.removeItem("treehouse:gh-token"),this.user=null,m&&m.redraw()}logout(){this.reset(),location.reload()}async readFile(e){try{let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:e,random:Math.random().toString(36).substring(2)});return this.shas[e]=n.data.sha,Se(n.data.content)}catch(n){return n.name!=="HttpError"&&console.error(n),null}}async writeFile(e,n){let t=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user?.userID(),repo:this.repo,path:e,message:"autosave",content:Le(n),sha:this.shas[e]});this.shas[e]=t.data.content.sha}};a(Q,"GitHubBackend");var V=class{constructor(e){this.user=e}userID(){return this.user.login}displayName(){return this.user.name}avatarURL(){return this.user.avatar_url}};a(V,"User");function Ee(){let r=Date.now().toString(36),e=Math.random().toString(36).substring(2);return r+e}a(Ee,"uniqueID");async function On(r,e,n){n.initialize&&await n.initialize();let t=new E(n);window.workbench=t,await t.initialize(),r.addEventListener("BackendError",()=>{t.showNotice("lockstolen",()=>{location.reload()})}),t.commands.registerCommand({id:"create-search",title:"Create Search Node",action:i=>{if(!i.node)return;let o=new L;i.node.addComponent(o),t.workspace.setExpanded(i.panel.headNode,i.node,!0)}}),t.commands.registerCommand({id:"view-list",title:"View as List",action:i=>{i.node&&i.node.setAttr("view","list")}}),t.commands.registerCommand({id:"view-table",title:"View as Table",action:i=>{i.node&&i.node.setAttr("view","table")}}),t.commands.registerCommand({id:"add-page",title:"Add page",action:i=>{if(!i.node)return;let o=new v;i.node.addComponent(o)}}),t.commands.registerCommand({id:"remove-page",title:"Remove page",action:i=>{i.node&&i.node.removeComponent(v)}}),t.commands.registerCommand({id:"add-checkbox",title:"Add checkbox",action:i=>{if(!i.node)return;let o=new w;i.node.addComponent(o)}}),t.commands.registerCommand({id:"remove-checkbox",title:"Remove checkbox",action:i=>{i.node&&i.node.removeComponent(w)}}),t.commands.registerCommand({id:"create-field",title:"Create Field",action:i=>{if(!i.node||i.node.childCount>0||i.node.componentCount>0)return;let o=t.workspace.new(i.node.name,"");o.raw.Parent=i.node.parent.id;let s=new S;o.addComponent(s),i.node.parent.addLinked("Fields",o),i.node.destroy(),m.redraw.sync(),t.focus(o)}}),t.commands.registerCommand({id:"mark-done",title:"Mark done",action:i=>{if(i.node)if(i.node.hasComponent(w)){let o=i.node.getComponent(w);o.checked?i.node.removeComponent(w):(o.checked=!0,i.node.changed())}else{let o=new w;i.node.addComponent(o)}}}),t.keybindings.registerBinding({command:"mark-done",key:"meta+enter"}),t.commands.registerCommand({id:"expand",title:"Expand",action:i=>{i.node&&(t.workspace.setExpanded(i.panel.headNode,i.node,!0),m.redraw())}}),t.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"}),t.commands.registerCommand({id:"collapse",title:"Collapse",action:i=>{i.node&&(t.workspace.setExpanded(i.panel.headNode,i.node,!1),m.redraw())}}),t.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"}),t.commands.registerCommand({id:"indent",title:"Indent",action:i=>{if(!i.node)return;let o=i.node.prevSibling;if(o!==null){i.node.parent=o,t.workspace.setExpanded(i.panel.headNode,o,!0);let s=i.node;m.redraw.sync(),t.focus(s)}}}),t.keybindings.registerBinding({command:"indent",key:"tab"}),t.commands.registerCommand({id:"outdent",title:"Outdent",action:i=>{if(!i.node)return;let o=i.node.parent;if(o!==null&&o.id!=="@root"){i.node.parent=o.parent,i.node.siblingIndex=o.siblingIndex+1,o.childCount===0&&t.workspace.setExpanded(i.panel.headNode,o,!1);let s=i.node;m.redraw.sync(),t.focus(s)}}}),t.keybindings.registerBinding({command:"outdent",key:"shift+tab"}),t.commands.registerCommand({id:"move-up",title:"Move Up",action:i=>{if(!i.node)return;let o=i.node,s=o.parent;if(s!==null&&s.id!=="@root"){let d=s.childCount;if(o.siblingIndex===0){if(!s.prevSibling)return;let l=s.prevSibling;o.parent=l,o.siblingIndex=l.childCount-1,t.workspace.setExpanded(i.panel.headNode,l,!0),m.redraw.sync(),t.focus(o)}else{if(d===1)return;o.siblingIndex=o.siblingIndex-1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-up",key:"shift+meta+arrowup"}),t.commands.registerCommand({id:"move-down",title:"Move Down",action:i=>{if(!i.node)return;let o=i.node,s=o.parent;if(s!==null&&s.id!=="@root"){let d=s.childCount;if(o.siblingIndex===d-1){if(!s.nextSibling)return;let l=s.nextSibling;o.parent=l,o.siblingIndex=0,t.workspace.setExpanded(i.panel.headNode,l,!0),m.redraw.sync(),t.focus(o)}else{if(d===1)return;o.siblingIndex=o.siblingIndex+1,m.redraw.sync()}}}}),t.keybindings.registerBinding({command:"move-down",key:"shift+meta+arrowdown"}),t.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(i,o="",s)=>{if(!i.node)return;let d=t.workspace.new(o);d.parent=i.node,s!==void 0&&(d.siblingIndex=s),t.workspace.setExpanded(i.panel.headNode,i.node,!0),m.redraw.sync(),t.focus(d,i.panel,o.length)}}),t.commands.registerCommand({id:"insert-before",title:"Insert Before",action:i=>{if(!i.node)return;let o=t.workspace.new("");o.parent=i.node.parent,o.siblingIndex=i.node.siblingIndex,m.redraw.sync(),t.focus(o,i.panel)}}),t.commands.registerCommand({id:"insert",title:"Insert Node",action:(i,o="")=>{if(!i.node)return;let s=t.workspace.new(o);s.parent=i.node.parent,s.siblingIndex=i.node.siblingIndex+1,m.redraw.sync(),t.focus(s,i.panel)}}),t.keybindings.registerBinding({command:"insert",key:"shift+enter"}),t.commands.registerCommand({id:"create-reference",title:"Create Reference",action:i=>{if(!i.node)return;let o=t.workspace.new("");o.parent=i.node.parent,o.siblingIndex=i.node.siblingIndex+1,o.refTo=i.node,m.redraw.sync(),t.focus(o,i.panel)}}),t.commands.registerCommand({id:"delete",title:"Delete node",action:i=>{if(!i.node||i.node.id.startsWith("@"))return;let o=t.workspace.findAbove(i.panel.headNode,i.node);if(i.node.destroy(),m.redraw.sync(),o){let s=0;i.event&&i.event.key==="Backspace"&&(s=o.name.length),o.childCount===0&&t.workspace.setExpanded(i.panel.headNode,o,!1),t.focus(o,i.panel,s)}}}),t.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"}),t.commands.registerCommand({id:"prev",action:i=>{if(!i.node)return;let o=t.workspace.findAbove(i.panel.headNode,i.node);o&&t.focus(o,i.panel)}}),t.keybindings.registerBinding({command:"prev",key:"arrowup"}),t.commands.registerCommand({id:"next",action:i=>{if(!i.node)return;let o=t.workspace.findBelow(i.panel.headNode,i.node);o&&t.focus(o,i.panel)}}),t.keybindings.registerBinding({command:"next",key:"arrowdown"}),t.commands.registerCommand({id:"pick-command",action:i=>{let o=i.node,s=!1;o||(o=i.panel.headNode,s=!0);let d=t.getInput(o),l=d.getBoundingClientRect(),u=r.body.scrollLeft+l.x+d.selectionStart*10+20,h=r.body.scrollTop+l.y-8;s&&(u=r.body.scrollLeft+l.x,h=r.body.scrollTop+l.y+l.height),t.showPalette(u,h,t.newContext({node:o}))}}),t.keybindings.registerBinding({command:"pick-command",key:"meta+k"}),t.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:i=>{i.node&&(t.openNewPanel(i.node),m.redraw())}}),t.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(i,o)=>{t.closePanel(o||i.node.panel),t.context.panel=t.mainPanel,m.redraw()}}),t.commands.registerCommand({id:"open",title:"Open",action:i=>{i.panel.open(i.node),t.workspace.lastOpenedID=i.node.id,t.workspace.save(),m.redraw()}}),t.commands.registerCommand({id:"generate-random",title:"Generate Random Children",action:i=>{i.node&&[...Array(100)].forEach(()=>{let o=t.workspace.new(De(8));o.parent=i.node})}}),t.menus.registerMenu("node",[{command:"open"},{command:"new-panel"},{command:"indent"},{command:"outdent"},{command:"move-up"},{command:"move-down"},{command:"delete"}]),t.menus.registerMenu("settings",[{title:()=>`${t.backend.auth?.currentUser()?.userID()} @ GitHub`,disabled:!0,when:()=>t.authenticated()},{title:()=>"Login with GitHub",when:()=>!t.authenticated(),onclick:()=>{localStorage.getItem("github")?t.backend.auth.login():t.showNotice("github",()=>{t.backend.auth.login()})}},{title:()=>"Reset Demo",when:()=>!t.authenticated(),onclick:()=>{localStorage.clear(),location.reload()}},{title:()=>"Submit Issue",onclick:()=>window.open("https://github.com/treehousedev/treehouse/issues","_blank")},{title:()=>"Logout",when:()=>t.authenticated(),onclick:()=>t.backend.auth.logout()}]),r.addEventListener("keydown",i=>{let o=t.keybindings.evaluateEvent(i);if(o){t.commands.executeCommand(o.command,t.context),i.stopPropagation(),i.preventDefault();return}i.key==="Escape"&&t.curtain&&t.curtain.onclick&&t.curtain.onclick(i)}),m.mount(e,{view:()=>m(pe,{workbench:t})})}a(On,"setup");function De(r=10){let e=a((i,o)=>Math.round(Math.random()*(o-i)+i),"random"),n=a(()=>{let i=["got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];return i[e(0,i.length-1)]},"word");return a(i=>[...Array(i)].map((o,s)=>n()).join(" ").trim(),"words")(e(2,r))}a(De,"generateName");export{R as BrowserBackend,Q as GitHubBackend,M as SearchIndex_MiniSearch,On as setup};
//# sourceMappingURL=treehouse.min.js.map
