var P=navigator.userAgent.toLowerCase().indexOf("mac")!==-1;function I(i){if(!i)return[];let e={backspace:"\u232B",shift:"\u21E7",meta:"\u2318",tab:"\u21B9",ctrl:"\u2303",uparrow:"\u2191",downarrow:"\u2193",leftarrow:"\u2190",rightarrow:"\u2192",enter:"\u23CE"};return i.toLowerCase().split("+").map(S).map(n=>Object.keys(e).includes(n)?e[n]:n)}function S(i){return!P&&i==="meta"?"ctrl":i}var w=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let o of this.bindings)if(o.command===e)return o;return null}evaluateEvent(e){e:for(let o of this.bindings){let n=o.key.toLowerCase().split("+");if(n.pop()===e.key.toLowerCase()){for(let r of["shift","ctrl","alt","meta"]){let d=n.includes(r);if(!P){if(r==="meta")continue;r==="ctrl"&&(d=n.includes("meta")||n.includes("ctrl"))}let a=e[`${S(r)}Key`];if(!a&&d||a&&!d)continue e}return o}}return null}};var D={view({attrs:i}){let e=i.workspace,o={margin:"0px",listStyleType:"none",padding:"0.25rem 0.5rem 0.25rem 0.5rem",display:"flex"},n={flexGrow:"1",textAlign:"right",color:"#888",marginLeft:"1rem"},t=r=>d=>{e.executeCommand(r.id,i.ctx),e.hideMenu(),d.stopPropagation()};return m("ul",{class:"menu",style:{margin:"0",position:"absolute",left:`${i.x}px`,top:`${i.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0.25rem 0 0.25rem 0",display:"inline-block",background:"white",filter:"drop-shadow(2px 2px 4px #5555)",fontSize:"14px",minWidth:"200px"}},i.items.map(r=>m("li",{onclick:t(r),style:o},m("div",null,r.title),m("div",{style:n},I(r.key).join("+")))))}};var M={onupdate({state:i,dom:e}){let o=e.querySelector(".commands").children;i.selected!==void 0&&o.length>0&&o[i.selected].scrollIntoView({block:"nearest"})},oncreate({dom:i}){i.querySelector("input").focus()},view({attrs:i,state:e}){let o=i.workspace;e.filter=e.filter===void 0?"":e.filter;let t=Object.values(o.commands.commands).filter(a=>a.id.startsWith(e.filter)),r=a=>{let l=(f,g)=>(f%g+g)%g;if(a.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=l(e.selected+1,t.length),!1}if(a.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=l(e.selected-1,t.length),!1;if(a.key==="Enter")return e.selected!==void 0&&(o.commands.executeCommand(t[e.selected].id,i.ctx),o.hidePalette()),!1;a.key==="Escape"&&o.hidePalette()},d=a=>{e.filter=a.target.value,e.selected=0};return m("div",{class:"palette",style:{margin:"0",position:"absolute",left:`${i.x}px`,top:`${i.y}px`,border:"1px solid #555",borderRadius:"0.25rem",padding:"0 0 0.25rem 0",background:"white",fontSize:"14px",minWidth:"200px"}},m("div",null,m("input",{style:{width:"100%"},type:"text",onkeydown:r,oninput:d,placeholder:"Enter command..."})),m("div",{class:"commands",style:{overflowY:"scroll",maxHeight:"100px",position:"relative"}},t.map((a,l)=>m("div",{class:e.selected===l?"selected":""},a.id))))}};var y=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...o){return this.commands[e].action(...o)}};var c=class{constructor(e,o){this.module=e,this.ID=o}changed(){this.module.changed(this)}get isDestroyed(){return!this.module.nodes.hasOwnProperty(this.ID)}get raw(){return this.module.nodes[this.ID]}getName(){return this.raw.Name}setName(e){this.raw.Name=e,this.changed()}getValue(){return this.raw.Value}getParent(){return this.raw.Parent?new c(this.module,this.raw.Parent):null}setParent(e){let o=this.getParent();o!==null&&o.raw.Linked.Children.splice(this.getSiblingIndex(),1),this.raw.Parent=e.ID,e.raw.Linked.Children.push(this.ID),this.changed()}getChildren(){return this.raw.Linked.Children?this.raw.Linked.Children.map(e=>new c(this.module,e)):[]}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,o){this.raw.Attrs[e]=o,this.changed()}getSiblingIndex(){let e=this.getParent();return e===null?0:e.raw.Linked.Children.findIndex(o=>o===this.ID)}setSiblingIndex(e){let o=this.getParent();o!==null&&(o.raw.Linked.Children.splice(this.getSiblingIndex(),1),o.raw.Linked.Children.splice(e,0,this.ID),o.changed())}getPrevSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===0?null:e.getChildren()[this.getSiblingIndex()-1]}getNextSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===e.getChildren().length-1?null:e.getChildren()[this.getSiblingIndex()+1]}destroy(){this.module.destroy(this)}},x=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}import(e){for(let o of e)this.nodes[o.ID]=o}export(){let e=[];for(let o of Object.values(this.nodes))e.push(o);return e}new(e,o){let n=e.startsWith("@")?e:B();return this.nodes[n]={ID:n,Name:e,Value:o,Linked:{Children:[],Components:[]},Attrs:{}},new c(this,n)}destroy(e){let o=e.getParent();o!==null&&o.raw.Linked.Children.splice(e.getSiblingIndex(),1),delete this.nodes[e.ID]}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new c(this,e.ID))}changed(e){this.observers.forEach(o=>o(e))}find(e){for(let o of Object.values(this.nodes))if(o.Name===e)return new c(this,o.ID);return null}},B=()=>{let i=Date.now().toString(36),e=Math.random().toString(36).substring(2);return i+e};function V(i){return{ID:B(),Name:i,Linked:{Children:[]},Attrs:{}}}function K(i){let e=[];for(let o=0;o<i;o++)e.push(V(H(u(2,6))));return e}function L(i){let e={},o=K(i);o.forEach(n=>{e[n.ID]=n,u(0,4)>0&&(n.Parent=o[u(0,i-1)].ID)});for(let[n,t]of Object.entries(e))t.Parent===t.ID&&(t.Parent=void 0),t.Parent&&e[t.Parent].Linked.Children.push(t.ID);return e}var R=["Got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];function q(i=!1){let e=R[u(0,R.length-1)];return i?e.charAt(0).toUpperCase()+e.slice(1):e}function H(i=10){return[...Array(i)].map((e,o)=>q(o===0)).join(" ").trim()}function u(i,e){return Math.round(Math.random()*(e-i)+i)}var b=class{constructor(){this.menus={}}registerMenu(e,o){this.menus[e]=o}};var v=class{constructor(e){e.panel=this,this.id=Math.random().toString(36).substring(2),this.history=[e]}};function p(i,e){return i.panel=e,i}var k=class{constructor(e){this.commands=new y,this.keybindings=new w,this.menus=new b,this.backend=e,this.nodes=new x;let o=this.backend.loadAll(),n=this.nodes.find("@root");if(o.length===0)for(let t of Object.values(L(1e3)))t.Parent===void 0&&(t.Parent="@root",n?.raw.Linked.Children.push(t.ID)),o.push(t);this.nodes.import(o),this.nodes.observers.push(t=>{this.backend.saveAll(Object.values(this.nodes.nodes))}),this.context={node:null},this.panels=[[]],this.expanded={},this.openNewPanel(this.nodes.find("@root"))}open(e){this.panels[0][0]=new v(e)}openNewPanel(e){this.expanded[e.ID]={};let o=new v(e);this.panels[0].push(o)}closePanel(e){this.panels.forEach((o,n)=>{this.panels[n]=o.filter(t=>t!==e)})}focus(e,o=0){this.context.node=e,document.getElementById(`input-${e.panel.id}-${e.ID}`)?.focus(),document.getElementById(`input-${e.panel.id}-${e.ID}`)?.setSelectionRange(o,o)}getInput(e){return document.getElementById(`input-${e.panel.id}-${e.ID}`)}executeCommand(e,o,...n){return this.commands.executeCommand(e,this.newContext(o),...n)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,o,n,t){let r=this.menus.menus[e];!r||(this.menu={x:o,y:n,ctx:this.newContext(t),items:r.map(d=>Object.assign(this.commands.commands[d.command],this.keybindings.getBinding(d.command)))},m.redraw())}hideMenu(){this.menu=null,m.redraw()}showPalette(e,o,n){this.palette={x:e,y:o,ctx:n},m.redraw()}hidePalette(){this.palette=null,m.redraw()}getExpanded(e){let o=this.expanded[e.panel.history[0].ID][e.ID];return o===void 0&&(o=!1),o}setExpanded(e,o){this.expanded[e.panel.history[0].ID][e.ID]=o}};var C={view({attrs:i,state:e,children:o}){let{node:n,workspace:t}=i,r=t.getExpanded(n),d=s=>{e.hover=!0,s.stopPropagation()},a=s=>{e.hover=!1,s.stopPropagation()},l=s=>{r?t.executeCommand("collapse",{node:n}):t.executeCommand("expand",{node:n}),s.stopPropagation()},f=s=>{t.context.node=n,e.editing=!0,e.buffer=n.getName()},g=s=>{e.editing=!1,n.isDestroyed||n.setName(e.buffer),e.buffer=void 0,t.context.node=null},T=s=>{e.buffer=s.target.value},j=s=>{t.executeCommand("insert-child",{node:n},s.target.value),s.stopPropagation()},$=s=>{let N=s.target.closest("*[data-menu]"),h=N.getBoundingClientRect(),z=document.body.scrollLeft+h.x,G=document.body.scrollTop+h.y+h.height;t.showMenu(N.dataset.menu,z,G,{node:n}),s.preventDefault()},W=s=>{switch(s.key){case"Backspace":if(s.target.value===""){t.executeCommand("delete",{node:n}),s.stopPropagation();return}if(s.target.value!==""&&s.target.selectionStart===0){console.log("TODO!"),s.stopPropagation();return}break;case"Enter":if(s.target.selectionStart===s.target.value.length){t.executeCommand("insert",{node:n}),s.stopPropagation();return}if(s.target.selectionStart===0){t.executeCommand("insert-before",{node:n}),s.stopPropagation();return}if(s.target.selectionStart>0&&s.target.selectionStart<s.target.value.length){e.buffer=s.target.value.slice(0,s.target.selectionStart),t.executeCommand("insert",{node:n},s.target.value.slice(s.target.selectionStart)),s.stopPropagation();return}break}};return m("div",{class:"",style:{paddingLeft:"1rem"},onmouseover:d,onmouseout:a},m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{flexShrink:"0",width:"1rem",height:"1rem",position:"absolute",marginLeft:"-1rem",userSelect:"none",display:e.hover?"block":"none"},onclick:l,fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),!r&&m("path",{style:{transform:"scale(0.6) translate(5px, 3px)"},d:"m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"}),r&&m("path",{style:{transform:"scale(0.6) translate(5px, 4px)"},d:"M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"})),m("svg",{oncontextmenu:$,"data-menu":"node",style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},n.getChildren().length>0?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{id:`input-${n.panel.id}-${n.ID}`,type:"text",value:e.editing?e.buffer:n.getName(),onfocus:f,onblur:g,oninput:T,onkeydown:W,style:{border:"0px",flexGrow:"1",outline:"0px"}}))),m("div",{style:{display:r?"flex":"none",flexDirection:"row",paddingBottom:"0.25rem"}},m("div",{style:{width:"1rem",marginRight:"0.25rem",display:"flex"},onclick:l},m("div",{style:{borderLeft:"1px solid gray",height:"100%",marginLeft:"0.5rem"}})),m("div",{style:{flexGrow:"1"}},n.getChildren().length>0?n.getChildren().map(s=>m(C,{key:s.ID,workspace:t,node:p(s,n.panel)})):m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:j,style:{border:"0px",flexGrow:"1",outline:"0px"}}))))))}};var A={view({attrs:i}){let e=i.panel,o=i.workspace,n=e.history[e.history.length-1],t=d=>{o.executeCommand("close-panel",{},e)},r=d=>{e.history.pop()};return m("div",{style:{flexGrow:"1",margin:"0.5rem"}},m("div",{style:{display:"flex"}},e.history.length>1?m("button",{onclick:r},"<"):null,m("div",{style:{flexGrow:"1"}},n.getName()),o.panels[0].length>1?m("button",{onclick:t},"x"):null),m("div",null,n.getChildren().map(d=>m(C,{key:d.ID,workspace:o,node:p(d,n.panel)}))))}};var E={view(i){let e=i.attrs.workspace;return m("main",null,m("button",{onclick:n=>{localStorage.clear(),location.reload()}},"Reset"),e.panels.map(n=>m("div",{style:{display:"flex"}},n.map(t=>m(A,{workspace:e,panel:t})))),e.menu&&m(D,{workspace:e,...e.menu}),e.palette&&m(M,{workspace:e,...e.palette}))}};var O=class{loadAll(){let e=localStorage.getItem("treehouse-nodes");return e==="undefined"&&(e=void 0),JSON.parse(e||"[]")}saveAll(e){localStorage.setItem("treehouse-nodes",JSON.stringify(e))}save(e){}};function ve(i,e,o){let n=new k(o);n.commands.registerCommand({id:"expand",title:"Expand",action:t=>{!t.node||(n.setExpanded(t.node,!0),m.redraw())}}),n.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"}),n.commands.registerCommand({id:"collapse",title:"Collapse",action:t=>{!t.node||(n.setExpanded(t.node,!1),m.redraw())}}),n.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"}),n.commands.registerCommand({id:"indent",title:"Indent",action:t=>{if(!t.node)return;let r=t.node.getPrevSibling();r!==null&&(t.node.setParent(r),r.setAttr("expanded",JSON.stringify(!0)),m.redraw.sync(),n.focus(t.node))}}),n.keybindings.registerBinding({command:"indent",key:"tab"}),n.commands.registerCommand({id:"outdent",title:"Outdent",action:t=>{if(!t.node)return;let r=t.node.getParent();r!==null&&r.ID!=="@root"&&(t.node.setParent(r.getParent()),t.node.setSiblingIndex(r.getSiblingIndex()+1),m.redraw.sync(),n.focus(t.node))}}),n.keybindings.registerBinding({command:"outdent",key:"shift+tab"}),n.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(t,r="")=>{if(!t.node)return;n.manifold.new(r).setParent(t.node),m.redraw.sync(),n.focus(t.node,r.length)}}),n.commands.registerCommand({id:"insert-before",title:"Insert Before",action:t=>{if(!t.node)return;let r=n.manifold.new("");r.setParent(t.node.getParent()),r.setSiblingIndex(t.node.getSiblingIndex()),m.redraw.sync(),n.focus(panelNode(r,t.node.panel))}}),n.commands.registerCommand({id:"insert",title:"Insert Node",action:(t,r="")=>{if(!t.node)return;let d=n.manifold.new(r);d.setParent(t.node.getParent()),d.setSiblingIndex(t.node.getSiblingIndex()+1),m.redraw.sync(),n.focus(panelNode(d,t.node.panel))}}),n.keybindings.registerBinding({command:"insert",key:"shift+enter"}),n.commands.registerCommand({id:"delete",title:"Delete node",action:t=>{if(!t.node)return;let r=t.node.getPrevSibling();t.node.destroy(),m.redraw.sync(),r&&n.focus(panelNode(r,t.node.panel))}}),n.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"}),n.commands.registerCommand({id:"prev",action:t=>{if(!t.node)return;let r=t.node.getPrevSibling();r!==null?n.focus(panelNode(r,t.node.panel)):n.focus(panelNode(t.node.getParent(),t.node.panel))}}),n.keybindings.registerBinding({command:"prev",key:"arrowup"}),n.commands.registerCommand({id:"next",action:t=>{if(!t.node)return;let r=t.node.getNextSibling();r!==null?n.focus(panelNode(r,t.node.panel)):n.focus(panelNode(t.node.getParent().getNextSibling(),t.node.panel))}}),n.keybindings.registerBinding({command:"next",key:"arrowdown"}),n.commands.registerCommand({id:"pick-command",action:t=>{if(!t.node)return;let d=n.getInput(t.node).getBoundingClientRect(),a=i.body.scrollLeft+d.x+200,l=i.body.scrollTop+d.y;n.showPalette(a,l,n.newContext({node:t.node}))}}),n.keybindings.registerBinding({command:"pick-command",key:"meta+k"}),n.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:t=>{!t.node||(n.openNewPanel(t.node),m.redraw())}}),n.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(t,r)=>{n.closePanel(r||t.node.panel),m.redraw()}}),n.commands.registerCommand({id:"zoom",title:"Zoom",action:t=>{t.node.panel.history.push(t.node),m.redraw()}}),n.keybindings.registerBinding({command:"zoom",key:"meta+z"}),n.menus.registerMenu("node",[{command:"zoom"},{command:"new-panel"},{command:"indent"},{command:"outdent"},{command:"delete"}]),i.addEventListener("keydown",t=>{let r=n.keybindings.evaluateEvent(t);r&&n.context.node&&(n.commands.executeCommand(r.command,n.context),t.stopPropagation(),t.preventDefault())}),i.addEventListener("click",t=>{n.hideMenu()}),m.mount(e,{view:()=>m(E,{workspace:n})})}export{O as LocalStorageStore,ve as setup};
