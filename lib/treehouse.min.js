var J=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var I=(i,e,n,t)=>{for(var o=t>1?void 0:t?X(e,n):e,r=i.length-1,s;r>=0;r--)(s=i[r])&&(o=(t?s(e,n,o):s(o))||o);return t&&o&&J(e,n,o),o};var E=navigator.userAgent.toLowerCase().indexOf("mac")!==-1;function z(i){if(!i)return[];let e={backspace:"\u232B",shift:"\u21E7",meta:"\u2318",tab:"\u21B9",ctrl:"\u2303",uparrow:"\u2191",downarrow:"\u2193",leftarrow:"\u2190",rightarrow:"\u2192",enter:"\u23CE"};return i.toLowerCase().split("+").map(H).map(t=>Object.keys(e).includes(t)?e[t]:t)}function H(i){return!E&&i==="meta"?"ctrl":i}var S=class{constructor(){this.bindings=[]}registerBinding(e){this.bindings.push(e)}getBinding(e){for(let n of this.bindings)if(n.command===e)return n;return null}evaluateEvent(e){e:for(let n of this.bindings){let t=n.key.toLowerCase().split("+");if(t.pop()===e.key.toLowerCase()){for(let r of["shift","ctrl","alt","meta"]){let s=t.includes(r);if(!E){if(r==="meta")continue;r==="ctrl"&&(s=t.includes("meta")||t.includes("ctrl"))}let a=e[`${H(r)}Key`];if(!a&&s||a&&!s)continue e}return n}}return null}};var P=class{constructor(){this.commands={}}registerCommand(e){this.commands[e.id]=e}executeCommand(e,...n){return this.commands[e].action(...n)}};var ee={};function D(i){let e=new Error().stack;if(e){let t=e.split(`
`)[3].split("/").pop()?.split(".")[0];i.__module=t}ee[x(i)]=i}function x(i){return i.constructor&&i.constructor.__module&&(i=i.constructor),i.__module?`${i.__module}.${i.name}`:i.name}var y=class{constructor(e,n){this.module=e,this.ID=n}changed(){this.module.changed(this)}get isDestroyed(){return!this.module.nodes.hasOwnProperty(this.ID)}get raw(){return this.module.nodes[this.ID]}getName(){return this.raw.Name}setName(e){this.raw.Name=e,this.changed()}getValue(){return this.raw.Value}getParent(){return this.raw.Parent?new y(this.module,this.raw.Parent):null}setParent(e){let n=this.getParent();n!==null&&n.raw.Linked.Children.splice(this.getSiblingIndex(),1),this.raw.Parent=e.ID,e.raw.Linked.Children.push(this.ID),this.changed()}getChildren(){return this.raw.Linked.Children?this.raw.Linked.Children.map(e=>new y(this.module,e)):[]}childCount(){return this.raw.Linked.Children?this.raw.Linked.Children.length:0}getAttr(e){return this.raw.Attrs[e]||""}setAttr(e,n){this.raw.Attrs[e]=n,this.changed()}getSiblingIndex(){let e=this.getParent();return e===null?0:e.raw.Linked.Children.findIndex(n=>n===this.ID)}setSiblingIndex(e){let n=this.getParent();n!==null&&(n.raw.Linked.Children.splice(this.getSiblingIndex(),1),n.raw.Linked.Children.splice(e,0,this.ID),n.changed())}getPrevSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===0?null:e.getChildren()[this.getSiblingIndex()-1]}getNextSibling(){let e=this.getParent();return e===null||this.getSiblingIndex()===e.getChildren().length-1?null:e.getChildren()[this.getSiblingIndex()+1]}destroy(){this.module.destroy(this)}addComponent(e){let n=this.module.new(x(e),e);n.raw.Parent=this.ID,this.raw.Linked.Components.push(n.ID),this.changed()}removeComponent(e){let n=this.getComponentNodes().filter(t=>t.getName()===x(e));n.length>0&&n[0].destroy(),this.changed()}hasComponent(e){return this.getComponentNodes().filter(t=>t.getName()===x(e)).length>0}getComponent(e){let n=this.getComponentNodes().filter(t=>t.getName()===x(e));return n.length>0?n[0].getValue():null}getComponentNodes(){return this.raw.Linked.Components?this.raw.Linked.Components.map(e=>new y(this.module,e)):[]}getPath(){let e=this,n=[];for(;e;)n.unshift(e.getName()),e=e.getParent();return n.join("/")}find(e){return this.module.find([this.getPath(),e].join("/"))}},M=class{constructor(){this.nodes={"@root":{ID:"@root",Name:"@root",Linked:{Children:[],Components:[]},Attrs:{}}},this.observers=[]}import(e){for(let n of e)this.nodes[n.ID]=n}export(){let e=[];for(let n of Object.values(this.nodes))e.push(n);return e}new(e,n){let t=null;if(e.includes("/")&&!e.startsWith("@")){let s=e.split("/");t=this.getRoot();for(let a=0;a<s.length-1;a++){if(t===null)throw"unable to get root";let l=t.find(s[a]);l||(l=this.new(s.slice(0,a+1).join("/"))),t=l}e=s[s.length-1]}let o=e.startsWith("@")?e:te();this.nodes[o]={ID:o,Name:e,Value:n,Linked:{Children:[],Components:[]},Attrs:{}};let r=new y(this,o);return t&&r.setParent(t),r}destroy(e){let n=e.getParent();n!==null&&(n.raw.Linked.Children.includes(e.ID)&&n.raw.Linked.Children.splice(e.getSiblingIndex(),1),n.raw.Linked.Components.includes(e.ID)&&n.raw.Linked.Components.splice(e.getSiblingIndex(),1)),delete this.nodes[e.ID],n&&this.changed(n)}roots(){return Object.values(this.nodes).filter(e=>e.Parent===void 0).map(e=>new y(this,e.ID))}changed(e){this.observers.forEach(n=>n(e))}getRoot(e){e=e||"@root";let n=this.roots().find(t=>t.getName()===e);return n===void 0?null:n}find(e){let n=this.nodes[e];if(n)return new y(this,n.ID);let t=e.split("/"),o="@root";if(t[0].startsWith("@")&&(o=t.shift()||"",t.length===0))return this.getRoot(o);let r=(a,l)=>a.getChildren().find(c=>c.getName()===l),s=this.getRoot(o);if(!s)return null;for(let a of t){let l=r(s,a);if(!l)return null;s=l}return s}walk(e){let n=(t,o)=>{if(o(t))return!0;for(let r of t.getChildren())if(n(r,o))return!0;return!1};for(let t of this.roots())if(n(t,e))return}},te=()=>{let i=Date.now().toString(36),e=Math.random().toString(36).substring(2);return i+e};var L=class{constructor(){this.menus={}}registerMenu(e,n){this.menus[e]=n}};var B=class{constructor(e){e.panel=this,this.id=Math.random().toString(36).substring(2),this.history=[e]}get current(){return this.history[this.history.length-1]}};function u(i,e){return i.panel=e,i}var b=class{constructor(e){this.commands=new P,this.keybindings=new S,this.menus=new L,this.backend=e,this.nodes=new M,this.context={node:null},this.panels=[[]],this.expanded={},this.openNewPanel(this.nodes.find("@root"))}async initialize(){let e=await this.backend.nodes.loadAll(),n=this.nodes.find("@root");if(e.length===0){let t=this.nodes.new("Workspace");t.setParent(n),this.nodes.new("Calendar").setParent(t),this.nodes.new("Home").setParent(t)}this.nodes.import(e),this.nodes.observers.push(t=>{this.backend.nodes.saveAll(Object.values(this.nodes.nodes)),this.backend.index.index(t.raw),t.getComponentNodes().forEach(o=>this.backend.index.index(o.raw))}),Object.values(this.nodes.nodes).forEach(t=>this.backend.index.index(t)),m.redraw()}authenticated(){return this.backend.auth&&this.backend.auth.currentUser()}closeQuickAdd(){this.quickadd=null,m.redraw()}openQuickAdd(){let e=this.nodes.find("@quickadd");e||(e=this.nodes.new("@quickadd")),this.quickadd=e}commitQuickAdd(){let e=this.nodes.find("@quickadd");if(!e)return;let n=this.todayNode();e.getChildren().forEach(t=>t.setParent(n))}clearQuickAdd(){let e=this.nodes.find("@quickadd");!e||e.getChildren().forEach(n=>n.destroy())}todayNode(){let e=new Date,n=e.toUTCString().split(e.getFullYear())[0],t=`Week ${String(ne(e)).padStart(2,"0")}`,o=`${e.getFullYear()}`,r=["Workspace","Calendar",o,t,n].join("/"),s=this.nodes.find(r);return s||(s=this.nodes.new(r)),s}openToday(){this.open(this.todayNode())}open(e){this.expanded[e.ID]||(this.expanded[e.ID]={}),localStorage.setItem("lastopen",e.ID),this.panels[0][0]=new B(e)}openNewPanel(e){this.expanded[e.ID]={},localStorage.setItem("lastopen",e.ID);let n=new B(e);this.panels[0].push(n)}closePanel(e){this.panels.forEach((n,t)=>{this.panels[t]=n.filter(o=>o!==e)})}focus(e,n=0){this.context.node=e,e&&(document.getElementById(`input-${e.panel?.id}-${e.ID}`)?.focus(),document.getElementById(`input-${e.panel?.id}-${e.ID}`)?.setSelectionRange(n,n))}getInput(e){return document.getElementById(`input-${e.panel?.id}-${e.ID}`)}executeCommand(e,n,...t){return this.commands.executeCommand(e,this.newContext(n),...t)}newContext(e){return Object.assign({},this.context,e)}showMenu(e,n){e.stopPropagation(),e.preventDefault();let t=e.target.closest("*[data-menu]"),o=t.getBoundingClientRect(),r=t.dataset.align||"left",s=document.body.scrollLeft+o.x;r==="right"&&(s=window.innerWidth-o.right-o.width);let a=document.body.scrollTop+o.y+o.height,l=this.menus.menus[t.dataset.menu],c=l.filter(g=>g.command).map(g=>this.commands.commands[g.command]);!l||(this.menu={x:s,y:a,ctx:this.newContext(n),items:l,commands:c,align:r},m.redraw())}hideMenu(){this.menu=null,m.redraw()}showPalette(e,n,t){this.palette={x:e,y:n,ctx:t},m.redraw()}hidePalette(){this.palette=null,m.redraw()}getExpanded(e){let n=e.ID;e.panel&&(n=e.panel.history[0].ID),this.expanded[n]||(this.expanded[n]={});let t=this.expanded[n][e.ID];return t===void 0&&(t=!1),t}setExpanded(e,n){this.expanded[e.panel.history[0].ID][e.ID]=n}};function ne(i){var e=new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate())),n=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-n);var t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)}var F={view({attrs:{workspace:i,x:e,y:n,items:t,align:o,commands:r,ctx:s}}){let a=(c,g)=>h=>{h.stopPropagation(),!c.disabled&&(c.onclick&&c.onclick(),g&&i.executeCommand(g.id,s),i.hideMenu())},l={left:`${e}px`};return o==="right"&&(l={right:`${e}px`}),m("ul",{class:"menu",style:Object.assign(l,{margin:"0",position:"absolute",top:`${n}px`,border:"1px solid var(--dark)",borderRadius:"0.25rem",padding:"0.25rem 0 0.25rem 0",display:"inline-block",background:"white",filter:"drop-shadow(2px 2px 4px #5555)",fontSize:"14px",minWidth:"200px"})},t.filter(c=>!c.when||c.when()).map(c=>{let g="",h,w;return c.command&&(w=r.find(k=>k.id===c.command),h=i.keybindings.getBinding(w.id),g=w.title),c.title&&(g=c.title()),m("li",{onclick:a(c,w),class:c.disabled?"disabled":"",style:{margin:"0px",listStyleType:"none",padding:"0.25rem 0.5rem 0.25rem 0.5rem",display:"flex"}},m("div",null,g),h&&m("div",{style:{flexGrow:"1",textAlign:"right",color:"#888",marginLeft:"1rem"}},z(h.key).join(" ").toUpperCase()))}))}};var O={onupdate({state:i,dom:e}){let n=e.querySelector(".commands").children;i.selected!==void 0&&n.length>0&&n[i.selected].scrollIntoView({block:"nearest"})},oncreate({dom:i}){i.querySelector("input").focus()},view({attrs:i,state:e}){let n=i.workspace;e.filter=e.filter===void 0?"":e.filter;let o=Object.values(n.commands.commands).filter(a=>a.id.startsWith(e.filter)),r=a=>{let l=(c,g)=>(c%g+g)%g;if(a.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=l(e.selected+1,o.length),!1}if(a.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=l(e.selected-1,o.length),!1;if(a.key==="Enter")return e.selected!==void 0&&(n.commands.executeCommand(o[e.selected].id,i.ctx),n.hidePalette()),!1;a.key==="Escape"&&n.hidePalette()},s=a=>{e.filter=a.target.value,e.selected=0};return m("div",{class:"palette",style:{margin:"0",position:"absolute",left:`${i.x}px`,top:`${i.y}px`,border:"1px solid var(--dark)",borderRadius:"0.25rem",padding:"0.5rem",background:"white",fontSize:"14px",minWidth:"400px"}},m("div",null,m("input",{style:{width:"98%",outline:"0",border:"0"},type:"text",onkeydown:r,oninput:s,placeholder:"Enter command..."})),m("div",{class:"commands",style:{margin:"0.25rem",overflowY:"scroll",maxHeight:"200px",position:"relative"}},o.map((a,l)=>m("div",{style:{padding:"0.25rem"},class:e.selected===l?"selected":""},a.title||a.id))))}};var T={view({attrs:i,state:e,children:n}){let{node:t,workspace:o}=i,r=o.getExpanded(t),s=d=>{e.hover=!0,d.stopPropagation()},a=d=>{e.hover=!1,d.stopPropagation()},l=d=>{r?o.executeCommand("collapse",{node:t}):o.executeCommand("expand",{node:t}),d.stopPropagation()},c=d=>{o.context.node=t,e.editing=!0,e.buffer=t.getName()},g=d=>{e.editing=!1,t.isDestroyed||t.setName(e.buffer),e.buffer=void 0,o.context.node=null},h=d=>{e.buffer=d.target.value,t.setName(e.buffer)},w=d=>{o.executeCommand("insert-child",{node:t},d.target.value),d.stopPropagation()},k=d=>{switch(d.key){case"Backspace":if(d.target.value===""){d.preventDefault(),t.getParent().ID===t.panel.current.ID?o.executeCommand("delete",{node:t,event:d}):o.executeCommand("outdent",{node:t}),d.stopPropagation();return}if(d.target.value!==""&&d.target.selectionStart===0){d.preventDefault();let v=t.getPrevSibling(),R=v.getName();v.setName(R+d.target.value),t.destroy(),m.redraw.sync(),o.focus(u(v,t.panel),R.length),d.stopPropagation();return}break;case"Enter":if(d.ctrlKey||d.shiftKey||d.metaKey||d.altKey)return;if(d.target.selectionStart===d.target.value.length){o.executeCommand("insert",{node:t}),d.stopPropagation();return}if(d.target.selectionStart===0){o.executeCommand("insert-before",{node:t}),d.stopPropagation();return}if(d.target.selectionStart>0&&d.target.selectionStart<d.target.value.length){e.buffer=d.target.value.slice(0,d.target.selectionStart),o.executeCommand("insert",{node:t},d.target.value.slice(d.target.selectionStart)),d.stopPropagation();return}break}},Y=d=>{let v=t.getComponent(p);v.checked=!v.checked,t.changed()},Z=d=>{d.preventDefault(),d.stopPropagation(),o.executeCommand("zoom",{node:t}),document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()};return m("div",{style:{paddingLeft:"1rem"},onmouseover:s,onmouseout:a},m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{xmlns:"http://www.w3.org/2000/svg",style:{cursor:"pointer",flexShrink:"0",width:"1rem",height:"1rem",position:"absolute",marginLeft:"-1rem",userSelect:"none",display:e.hover?"block":"none"},onclick:d=>o.showMenu(d,{node:t}),oncontextmenu:d=>o.showMenu(d,{node:t}),"data-menu":"node",fill:"lightgray",viewBox:"0 0 16 16"},m("path",{style:{transform:"translateY(-1px)"},"fill-rule":"evenodd",d:"M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"})),m("svg",{onclick:l,ondblclick:Z,oncontextmenu:d=>o.showMenu(d,{node:t}),"data-menu":"node",style:{cursor:"pointer",flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},t.childCount()>0&&!r?m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}):null,m("circle",{cx:"8",cy:"7",r:"3"})),m("div",{style:{flexGrow:"1",display:"flex"}},t.hasComponent(p)?m("input",{type:"checkbox",onclick:Y,checked:t.getComponent(p).checked}):null,m("input",{id:`input-${t.panel?.id}-${t.ID}`,type:"text",value:e.editing?e.buffer:t.getName(),onfocus:c,onblur:g,oninput:h,onkeydown:k,style:{border:"0px",flexGrow:"1",outline:"0px"}}))),m("div",{style:{display:r?"flex":"none",flexDirection:"row",paddingBottom:"0.25rem"}},m("div",{style:{width:"1rem",marginRight:"0.25rem",display:"flex"},onclick:l},m("div",{style:{borderLeft:"1px solid gray",height:"100%",marginLeft:"0.5rem"}})),m("div",{style:{flexGrow:"1"}},t.childCount()>0?t.getChildren().map(d=>m(T,{key:d.ID,workspace:o,node:u(d,t.panel)})):m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:w,style:{border:"0px",flexGrow:"1",outline:"0px"}}))))))}},C={view({attrs:i,state:e}){let n=i.node,t=i.workspace,o=r=>{t.executeCommand("insert-child",{node:n},r.target.value),r.stopPropagation()};return m("div",{style:{padding:"var(--padding)"}},n.getChildren().map(r=>m(T,{key:r.ID,workspace:t,node:u(r,n.panel)})),m("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",paddingLeft:"1rem",marginTop:"0.125rem",marginBottom:"0.125rem"}},m("svg",{style:{flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.5rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},m("circle",{cx:"8",cy:"7",r:"7",fill:"lightgray"}),m("path",{fill:"#555",style:{transform:"translate(0px, -1px)"},d:"M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"})),m("div",{style:{flexGrow:"1",display:"flex"}},m("input",{type:"text",oninput:o,value:"",style:{border:"0px",flexGrow:"1",outline:"0px"}}))))}};var V={view({attrs:i}){let e=i.panel,n=i.workspace,t=e.history[e.history.length-1],o=h=>{n.executeCommand("close-panel",{},e)},r=h=>{e.history.pop()},s=h=>{n.panels=[[e]]},a=h=>{n.closePanel(e),n.panels.push([e])},l=h=>{n.closePanel(e),n.panels.unshift([e])},c=h=>{t.getComponent(f).markdown=h.target.value,t.changed()};function g(h=""){let w=(h.match(/\n/g)||[]).length;return 20+w*20}return m("div",{style:{display:"flex",flexDirection:"column",flexGrow:"1",margin:"var(--padding)",paddingBottom:"var(--padding)",height:"92vh"}},m("div",{style:{display:"flex",background:"white",borderRadius:"0.5rem",color:"gray",padding:"var(--padding)",paddingTop:"0.5rem",paddingBottom:"0.5rem",gap:"var(--padding)",marginBottom:"0.5rem"}},e.history.length>1?m("div",{style:{rightPadding:"var(--padding)"}},m("svg",{onclick:r,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{"fill-rule":"evenodd",d:"M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"}))):null,m("div",{style:{flexGrow:"1"}},t.getParent()&&m("span",{style:{cursor:"pointer"},onclick:()=>n.open(t.getParent())},t.getParent().getName())),n.panels.flat().length>1?m("div",{style:{display:"flex",gap:"0.5rem"}},m("svg",{onclick:a,style:{cursor:"pointer",transform:"scaleY(-1)"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M2.375 1A2.366 2.366 0 0 0 0 3.357v9.286A2.366 2.366 0 0 0 2.375 15h11.25A2.366 2.366 0 0 0 16 12.643V3.357A2.366 2.366 0 0 0 13.625 1H2.375ZM1 3.357C1 2.612 1.611 2 2.375 2h11.25C14.389 2 15 2.612 15 3.357V4H1v-.643ZM1 5h14v7.643c0 .745-.611 1.357-1.375 1.357H2.375A1.366 1.366 0 0 1 1 12.643V5Z"})),m("svg",{onclick:l,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M2.375 1A2.366 2.366 0 0 0 0 3.357v9.286A2.366 2.366 0 0 0 2.375 15h11.25A2.366 2.366 0 0 0 16 12.643V3.357A2.366 2.366 0 0 0 13.625 1H2.375ZM1 3.357C1 2.612 1.611 2 2.375 2h11.25C14.389 2 15 2.612 15 3.357V4H1v-.643ZM1 5h14v7.643c0 .745-.611 1.357-1.375 1.357H2.375A1.366 1.366 0 0 1 1 12.643V5Z"})),m("svg",{onclick:s,style:{cursor:"pointer",transform:"scale(0.9)"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"})),m("svg",{onclick:o,style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"}))):null),m("div",{style:{background:"white",borderRadius:"0.5rem",display:"flex",flexDirection:"column"}},m("div",{oncontextmenu:h=>n.showMenu(h,{node:t}),"data-menu":"node",style:{padding:"var(--padding)",fontSize:"2rem"}},t.getName()),t.hasComponent(f)?m("textarea",{oninput:c,value:t.getComponent(f).markdown,placeholder:"Enter Markdown text here",style:{marginLeft:"var(--padding)",padding:"var(--padding)",outline:"0",height:`${g(t.getComponent(f).markdown)}px`,border:"0"}},t.getComponent(f).markdown):null,m(C,{workspace:n,node:t})))}};var $={view({attrs:{workspace:i}}){return m("div",{style:{position:"absolute",left:"0",right:"0",top:"0",bottom:"0"}},m("div",{onclick:()=>i.closeQuickAdd(),style:{position:"absolute",background:"black",opacity:"50%",width:"100%",height:"100%"}}),m("div",{style:{position:"relative",marginLeft:"auto",marginRight:"auto",width:"45vw",borderRadius:"0.5rem",filter:"drop-shadow(2px 2px 4px #5555)",marginTop:"20vh",padding:"2rem",background:"white"}},m("h3",{style:{margin:"0"}},"Quick Add"),m("hr",null),m(C,{workspace:i,node:i.quickadd}),m("hr",null),m("div",{style:{textAlign:"right"}},m("button",{style:{padding:"0.5rem",margin:"0.25rem"},onclick:()=>{i.commitQuickAdd(),i.closeQuickAdd()}},"Add to Today"))))}};var j={onupdate({state:i,dom:e}){let n=e.querySelector(".results");n&&i.selected!==void 0&&n.children.length>0&&n.children[i.selected].scrollIntoView({block:"nearest"})},view({attrs:{workspace:i},state:e}){e.query=e.query===void 0?"":e.query;let n=[];e.query&&(n=i.backend.index.search(e.query).map(s=>{let a=i.nodes.find(s);if(!!a&&!(a.getValue()&&(a=a.getParent(),!a.raw)))return a}).filter(s=>s!==void 0));let t=s=>{i.open(s),e.query=""},o=s=>{let a=(l,c)=>(l%c+c)%c;if(s.key==="ArrowDown"){if(e.selected===void 0){e.selected=0;return}return e.selected=a(e.selected+1,n.length),!1}if(s.key==="ArrowUp")return e.selected===void 0&&(e.selected=0),e.selected=a(e.selected-1,n.length),!1;if(s.key==="Enter")return e.selected!==void 0&&t(n[e.selected]),!1;s.key==="Escape"&&(e.query="")},r=s=>{e.query=s.target.value,e.selected=0};return m("div",{class:"search",style:{position:"relative",display:"flex",flexGrow:"1",padding:"calc(var(--padding)/2)"}},m("div",{style:{width:"95%",padding:"calc(var(--padding)/2)",borderRadius:"0.25rem",border:n.length>0?"1px solid var(--dark)":"none",position:"absolute",background:n.length>0?"white":null}},m("input",{type:"text",placeholder:"Search",value:e.query,onkeydown:o,oninput:r,style:{width:"99%",border:"0",outline:"0",background:"transparent",marginRight:"var(--padding)"}}),n.length>0?m("div",{class:"results",style:{marginTop:"0.25rem",overflowX:"hidden",overflowY:"auto",maxHeight:"400px"}},n.map((s,a)=>m("div",{onclick:()=>t(s),class:e.selected===a?"selected":""},s.getName()))):null))}};var q={view({attrs:{workspace:i},state:e}){e.open=e.open===void 0?!0:e.open;let n=t=>{e.open?e.open=!1:e.open=!0};return m("main",{style:{margin:"0",display:"flex",flexDirection:"column",position:"absolute",top:"0",bottom:"0",left:"0",right:"0"}},m("div",{style:{display:"flex",borderBottom:"1px solid var(--dark)"}},e.open&&m("div",{style:{width:"200px",display:"flex",padding:"var(--padding)"}},m("div",{style:{flexGrow:"1"}},m("img",{src:"/icon_transparent.png",style:{opacity:"70%",width:"16px",height:"16px"}})),m("svg",{onclick:n,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",class:"bi bi-layout-sidebar",viewBox:"0 0 16 16"},m("path",{d:"M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm5-1v12h9a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H5zM4 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h2V2z"}))),m("div",{style:{flexGrow:"1",display:"flex"}},!e.open&&m("svg",{onclick:n,style:{padding:"var(--padding)",borderLeft:"1px solid var(--dark)"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",class:"bi bi-layout-sidebar",viewBox:"0 0 16 16"},m("path",{d:"M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3zm5-1v12h9a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H5zM4 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h2V2z"})),m("div",{style:{borderLeft:"1px solid var(--dark)"}}),m("div",{onclick:()=>i.openToday(),style:{cursor:"pointer",padding:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{style:{marginRight:"0.25rem",height:"1rem",width:"1rem"},xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"}),m("path",{d:"M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5V4z"}),m("text",{"text-anchor":"middle",x:"8",y:"13",style:{fontSize:"0.55rem"}},new Date().getDate())),m("div",null,"Today")),m("div",{style:{borderLeft:"1px solid var(--dark)"}}),m("div",{onclick:()=>i.openQuickAdd(),style:{cursor:"pointer",padding:"var(--padding)",display:"flex",alignItems:"center"}},m("svg",{style:{marginRight:"0.25rem",height:"1rem",width:"1rem"},xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09zM4.157 8.5H7a.5.5 0 0 1 .478.647L6.11 13.59l5.732-6.09H9a.5.5 0 0 1-.478-.647L9.89 2.41 4.157 8.5z"})),m("div",null,"Quick Add")),m("div",{style:{borderLeft:"1px solid var(--dark)"}}),m(j,{workspace:i}),m("div",{style:{borderLeft:"1px solid var(--dark)"}}),m("div",{style:{padding:"var(--padding)"}},m("svg",{onclick:t=>i.showMenu(t),"data-menu":"settings","data-align":"right",style:{cursor:"pointer"},xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},m("path",{d:"M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z"}))))),m("div",{style:{display:"flex",flexGrow:"1"}},e.open&&m("div",{style:{width:"200px",padding:"var(--padding)"}},i.nodes.getRoot().getChildren().map(t=>m(U,{node:t,expanded:!0,workspace:i}))),m("div",{style:{flexGrow:"1",borderLeft:"1px solid var(--dark)"}},i.panels.map(t=>m("div",{style:{display:"flex"}},t.map(o=>m(V,{workspace:i,panel:o})))))),i.menu&&m(F,{workspace:i,...i.menu}),i.palette&&m(O,{workspace:i,...i.palette}),i.quickadd&&m($,{workspace:i}))}},U={view({attrs:{node:i,workspace:e,expanded:n},state:t}){t.expanded=t.expanded===void 0?n:t.expanded;let o=s=>{t.expanded?t.expanded=!1:t.expanded=!0,s.stopPropagation()},r=s=>{e.open(i)};return m("div",null,m("div",{style:{display:"flex"}},m("svg",{onclick:o,style:{cursor:"pointer",flexShrink:"0",width:"1rem",height:"1rem",marginRight:"0.25rem",paddingLeft:"1px"},xmlns:"http://www.w3.org/2000/svg",fill:"gray",viewBox:"0 0 16 16"},i.childCount()>0?t.expanded?m("path",{d:"M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 0 0 1.506 0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 0 0-.753 1.659z"}):m("path",{d:"M6 12.796V3.204L11.481 8 6 12.796zm.659.753 5.48-4.796a1 1 0 0 0 0-1.506L6.66 2.451C6.011 1.885 5 2.345 5 3.204v9.592a1 1 0 0 0 1.659.753z"}):null),m("div",{onclick:r,style:{cursor:"pointer",flexGrow:"1",display:"flex"}},i.getName())),t.expanded&&m("div",{style:{paddingBottom:"0.25rem",marginLeft:"0.5rem"}},i.getChildren().filter(s=>s.getName()!=="").map(s=>m(U,{workspace:e,node:s}))))}};var N=class{constructor(){this.auth=null,this.files=new Q,this.nodes=new W(this.files),window.MiniSearch?this.index=new A:this.index=new G}},A=class{constructor(){this.indexer=new MiniSearch({idField:"ID",fields:["ID","Name","Value.markdown"],storeFields:["ID"],extractField:(e,n)=>n.split(".").reduce((t,o)=>t&&t[o],e)})}index(e){this.indexer.has(e.ID)?this.indexer.replace(e):this.indexer.add(e)}remove(e){this.indexer.discard(e)}search(e){let n=this.indexer.autoSuggest(e);return n.length===0?[]:this.indexer.search(n[0].suggestion).map(t=>t.ID)}},G=class{constructor(){this.nodes={}}index(e){this.nodes[e.ID]=e.Name}remove(e){delete this.nodes[e]}search(e){let n=[];for(let t in this.nodes)this.nodes[t].includes(e)&&n.push(t);return n}},W=class{constructor(e){this.files=e}async loadAll(){return JSON.parse(await this.files.readFile("workspace.json")||"[]")}async saveAll(e){await this.files.writeFile("workspace.json",JSON.stringify(e))}},Q=class{async readFile(e){return localStorage.getItem(`treehouse:${e}`)}async writeFile(e,n){localStorage.setItem(`treehouse:${e}`,n)}};var _=class{constructor(e,n){this.loginURL=e,this.clientFactory=n,this.auth=this,this.shas={};let t=new N;this.index=t.index,this.nodes=t.nodes,this.files=t.files,this.writeDebounce=oe((o,r)=>{console.log("Saving workspace..."),this.writeFile(o,r)})}get repo(){return`${this.user?.userID()}.treehouse.sh`}async initialize(){let e=new URL(location.href).searchParams.get("code");if(e)try{let n=location.search.replace(/\bcode=\w+/,"").replace(/\?$/,"");history.pushState({},"",`${location.pathname}${n}`);let o=await(await fetch(this.loginURL,{method:"POST",mode:"cors",headers:{"content-type":"application/json"},body:JSON.stringify({code:e})})).json();if(o.error)throw o.error;localStorage.setItem("treehouse:gh-token",o.token)}catch(n){this.reset(),console.error(n);return}if(await this.authenticate(),!this.user){console.error("authentication failed");return}try{await this.client.rest.repos.get({owner:this.user.userID(),repo:this.repo})}catch(n){if(n.message!=="Not Found")throw n;console.log("Creating repository...");let t=await this.client.rest.repos.createForAuthenticatedUser({name:this.repo});if(t.status!==201){console.error(t);return}}try{await this.client.rest.repos.getContent({owner:this.user.userID(),repo:this.repo,path:"workspace.json"})}catch(n){if(n.name!=="HttpError")throw n;console.log("Creating workspace.json...");let t=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user.userID(),repo:this.repo,path:"workspace.json",message:"initial commit",content:btoa(JSON.stringify([]))});if(t.status!==201){console.error(t);return}}this.files=this,this.nodes=this}async authenticate(){let e=localStorage.getItem("treehouse:gh-token");if(!e)return;this.client=new this.clientFactory({auth:e});let n=await this.client.rest.users.getAuthenticated();!n||n.error||(this.user=new K(n.data),m&&m.redraw())}currentUser(){return this.user}login(){location.assign(this.loginURL)}reset(){localStorage.removeItem("treehouse:gh-token"),this.user=null,m&&m.redraw()}logout(){this.reset(),location.reload()}async loadAll(){return JSON.parse(await this.readFile("workspace.json")||"[]")}async saveAll(e){this.writeDebounce("workspace.json",JSON.stringify(e,null,2))}async readFile(e){try{let n=await this.client.rest.repos.getContent({owner:this.user?.userID(),repo:this.repo,path:e,random:Math.random().toString(36).substring(2)});return this.shas[e]=n.data.sha,atob(n.data.content)}catch(n){return n.name!=="HttpError"&&console.error(n),null}}async writeFile(e,n){let t=await this.client.rest.repos.createOrUpdateFileContents({owner:this.user?.userID(),repo:this.repo,path:e,message:"autosave",content:btoa(n),sha:this.shas[e]});this.shas[e]=t.data.content.sha}},K=class{constructor(e){this.user=e}userID(){return this.user.login}displayName(){return this.user.name}avatarURL(){return this.user.avatar_url}};function oe(i,e=3e3){let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>{i.apply(this,t)},e)}}var p=class{constructor(){this.checked=!1}};p=I([D],p);var f=class{constructor(){this.markdown=""}};f=I([D],f);async function We(i,e,n){n.initialize&&await n.initialize();let t=new b(n);await t.initialize(),window.workspace=t,t.commands.registerCommand({id:"add-page",title:"Add page",action:o=>{if(!o.node)return;let r=new f;o.node.addComponent(r)}}),t.commands.registerCommand({id:"remove-page",title:"Remove page",action:o=>{!o.node||o.node.removeComponent(f)}}),t.commands.registerCommand({id:"add-checkbox",title:"Add checkbox",action:o=>{if(!o.node)return;let r=new p;o.node.addComponent(r)}}),t.commands.registerCommand({id:"remove-checkbox",title:"Remove checkbox",action:o=>{!o.node||o.node.removeComponent(p)}}),t.commands.registerCommand({id:"mark-done",title:"Mark done",action:o=>{if(!!o.node)if(o.node.hasComponent(p)){let r=o.node.getComponent(p);r.checked?o.node.removeComponent(p):(r.checked=!0,o.node.changed())}else{let r=new p;o.node.addComponent(r)}}}),t.keybindings.registerBinding({command:"mark-done",key:"meta+enter"}),t.commands.registerCommand({id:"expand",title:"Expand",action:o=>{!o.node||(t.setExpanded(o.node,!0),m.redraw())}}),t.keybindings.registerBinding({command:"expand",key:"meta+arrowdown"}),t.commands.registerCommand({id:"collapse",title:"Collapse",action:o=>{!o.node||(t.setExpanded(o.node,!1),m.redraw())}}),t.keybindings.registerBinding({command:"collapse",key:"meta+arrowup"}),t.commands.registerCommand({id:"indent",title:"Indent",action:o=>{if(!o.node)return;let r=u(o.node.getPrevSibling(),o.node.panel);if(r!==null){o.node.setParent(r),t.setExpanded(r,!0);let s=o.node;m.redraw.sync(),t.focus(s)}}}),t.keybindings.registerBinding({command:"indent",key:"tab"}),t.commands.registerCommand({id:"outdent",title:"Outdent",action:o=>{if(!o.node)return;let r=u(o.node.getParent(),o.node.panel);if(r!==null&&r.ID!=="@root"){o.node.setParent(r.getParent()),o.node.setSiblingIndex(r.getSiblingIndex()+1),r.childCount()===0&&t.setExpanded(r,!1);let s=o.node;m.redraw.sync(),t.focus(s)}}}),t.keybindings.registerBinding({command:"outdent",key:"shift+tab"}),t.commands.registerCommand({id:"insert-child",title:"Insert Child",action:(o,r="")=>{if(!o.node)return;let s=t.nodes.new(r);s.setParent(o.node),m.redraw.sync(),t.focus(u(s,o.node.panel),r.length)}}),t.commands.registerCommand({id:"insert-before",title:"Insert Before",action:o=>{if(!o.node)return;let r=t.nodes.new("");r.setParent(o.node.getParent()),r.setSiblingIndex(o.node.getSiblingIndex()),m.redraw.sync(),t.focus(u(r,o.node.panel))}}),t.commands.registerCommand({id:"insert",title:"Insert Node",action:(o,r="")=>{if(!o.node)return;let s=t.nodes.new(r);s.setParent(o.node.getParent()),s.setSiblingIndex(o.node.getSiblingIndex()+1),m.redraw.sync(),t.focus(u(s,o.node.panel))}}),t.keybindings.registerBinding({command:"insert",key:"shift+enter"}),t.commands.registerCommand({id:"delete",title:"Delete node",action:o=>{if(!o.node)return;let r=o.node.getPrevSibling();if(o.node.destroy(),m.redraw.sync(),r){let s=0;o.event&&o.event.key==="Backspace"&&(s=r.getName().length),t.focus(u(r,o.node.panel),s)}}}),t.keybindings.registerBinding({command:"delete",key:"shift+meta+backspace"}),t.commands.registerCommand({id:"prev",action:o=>{if(!o.node)return;let r=o.node.getPrevSibling();r!==null?t.focus(u(r,o.node.panel)):t.focus(u(o.node.getParent(),o.node.panel))}}),t.keybindings.registerBinding({command:"prev",key:"arrowup"}),t.commands.registerCommand({id:"next",action:o=>{if(!o.node)return;let r=o.node.getNextSibling();if(r!==null)t.focus(u(r,o.node.panel));else return}}),t.keybindings.registerBinding({command:"next",key:"arrowdown"}),t.commands.registerCommand({id:"pick-command",action:o=>{if(!o.node)return;let r=t.getInput(o.node),s=r.getBoundingClientRect(),a=i.body.scrollLeft+s.x+r.selectionStart*10+20,l=i.body.scrollTop+s.y-8;t.showPalette(a,l,t.newContext({node:o.node}))}}),t.keybindings.registerBinding({command:"pick-command",key:"meta+k"}),t.commands.registerCommand({id:"new-panel",title:"Open in New Panel",action:o=>{!o.node||(t.openNewPanel(o.node),m.redraw())}}),t.commands.registerCommand({id:"close-panel",title:"Close Panel",action:(o,r)=>{t.closePanel(r||o.node.panel),m.redraw()}}),t.commands.registerCommand({id:"zoom",title:"Open",action:o=>{o.node.panel.history.push(o.node),m.redraw()}}),t.commands.registerCommand({id:"generate-random",title:"Generate Random Children",action:o=>{!o.node||[...Array(100)].forEach(()=>{t.nodes.new(ie(8)).setParent(o.node)})}}),t.menus.registerMenu("node",[{command:"zoom"},{command:"new-panel"},{command:"indent"},{command:"outdent"},{command:"delete"},{command:"add-checkbox"},{command:"remove-checkbox"},{command:"mark-done"},{command:"add-page"},{command:"remove-page"},{command:"generate-random"}]),t.menus.registerMenu("settings",[{title:()=>`${t.backend.auth?.currentUser()?.userID()} @ GitHub`,disabled:!0,when:()=>t.authenticated()},{title:()=>"Login with GitHub",when:()=>!t.authenticated(),onclick:()=>t.backend.auth.login()},{title:()=>"Reset Demo",when:()=>!t.authenticated(),onclick:()=>{localStorage.clear(),location.reload()}},{title:()=>"Submit Issue",onclick:()=>window.open("https://github.com/treehousedev/treehouse/issues","_blank")},{title:()=>"Logout",when:()=>t.authenticated(),onclick:()=>t.backend.auth.logout()}]),i.addEventListener("keydown",o=>{let r=t.keybindings.evaluateEvent(o);r&&t.context.node&&(t.commands.executeCommand(r.command,t.context),o.stopPropagation(),o.preventDefault())}),i.addEventListener("click",o=>{t.hideMenu()}),m.mount(e,{view:()=>m(q,{workspace:t})})}function ie(i=10){let e=(o,r)=>Math.round(Math.random()*(r-o)+o),n=()=>{let o=["got","ability","shop","recall","fruit","easy","dirty","giant","shaking","ground","weather","lesson","almost","square","forward","bend","cold","broken","distant","adjective"];return o[e(0,o.length-1)]};return(o=>[...Array(o)].map((r,s)=>n()).join(" ").trim())(e(2,i))}export{N as BrowserBackend,p as Checkbox,_ as GitHubBackend,f as Page,A as SearchIndex_MiniSearch,We as setup};
